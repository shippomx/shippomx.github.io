<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>部署ftrace出现内存越界 | 远辰</title><meta name="keywords" content="linux"><meta name="author" content="哪吒藕霸"><meta name="copyright" content="哪吒藕霸"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="部署ftrace出现内存越界"><meta name="application-name" content="部署ftrace出现内存越界"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="部署ftrace出现内存越界"><meta property="og:url" content="https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="远辰"><meta property="og:description" content="1.引言本文分析一起由内存越界导致的内核 oops 问题。先通过现场信息分析，确认问题是源于 vmalloc 子系统管理的链表和红黑树中出现了不正常的空节点；然后再添加调试信息，确认了现场的空节点是内存被踩导致；之后复现问题，分析告警信息，最终定位问题来源于产品驱动代码存在越界写操作。 虽然问题由部"><meta property="og:locale" content="zh"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="哪吒藕霸"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="1.引言本文分析一起由内存越界导致的内核 oops 问题。先通过现场信息分析，确认问题是源于 vmalloc 子系统管理的链表和红黑树中出现了不正常的空节点；然后再添加调试信息，确认了现场的空节点是内存被踩导致；之后复现问题，分析告警信息，最终定位问题来源于产品驱动代码存在越界写操作。 虽然问题由部"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 哪吒藕霸","link":"链接: ","source":"来源: 远辰","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '远辰',
  title: '部署ftrace出现内存越界',
  postAI: '',
  pageFillDescription: '1.引言, 2. 问题背景, 3. 问题分析, 3.1 现场一分析, 3.2 现场二分析, 3.3 基于现场分析的下一步调试思路, 3.4 添加调试代码后复现分析, 3.5 踩内存问题分析, 3.6 配置 kasan 后分析, 3.7 问题解决, 4. 经验总结, 4.1 延伸引言本文分析一起由内存越界导致的内核问题先通过现场信息分析确认问题是源于子系统管理的链表和红黑树中出现了不正常的空节点然后再添加调试信息确认了现场的空节点是内存被踩导致之后复现问题分析告警信息最终定位问题来源于产品驱动代码存在越界写操作虽然问题由部署功能引起但本质该问题是由于产品代码存在内存越界操作导致的部署使得内存使用发生变化将问题触发出来如果没有进行的部署操作和问题定位在外场极有可能引发偶现内核且该类内存越界问题很难快速定位影响较大下面就具体问题进行描述其内容包括问题背景现场分析如何判断是内存越界问题以及对于该类内存越界如何进行排查分析问题背景某产品需要部署功能用于故障动态分析在其内核配置功能之后基本必现内核访问非法地址异常其异常主要有两种现场问题分析对于内核出现异常我们首先需要做的就是分析现场查看出现问题的直接原因基于此再做下一步的判断如下我们针对提供的两个异常现场分别进行分析现场一分析异常现场记录指令寄存器为其中异常指令为的位置函数大小为先使用命令反汇编获取指令汇编内容确认中函数大小为之后查看异常指令位置和执行逻辑如下异常访问对应的指令对应异常指令为可以看到其访问对应地址的内容由于寄存器内容为对应的进制为导致后续访问异常地址输出告警信息基于现有的使用工具获取指令对应的代码位置对应代码如下异常指令位置从代码上看这一行中进行地址访问只有来源于结合为结构体指针是的偏移成员的结构体如下因此代码是通过获取的地址然后在访问地址内容也就是结构体的第一个成员对应到反汇编代码上我们就可以知道当前是的内容这也就说明链表里面存储为指针而正常空链表里面的指针是指向自己所在地址不会是但其为空的原因当前现场信息无法进行进一步排查现场二分析由于还存在另外一种异常继续分析下一处异常对应现场为查看中对应位置的反汇编指令为对应是访问的地址的内容并赋值给可以看到现场寄存器为导致访问了异常地址并告警地址内容赋值给判断是否为把地址内容赋值给判断的第一位是否为异常指令把地址内容赋值给查看对应代码对应代码如下异常代码位置是结构体偏移字节的成员说明代码中的为也就是变量为空指针导致后续异常前面执行只判断了的最后一位是否为不判断空指针从代码流程上看在第一次循环情况下其来源于对应根据汇编代码回溯寄存器的来源把地址存储的内容赋值给因此是对应现场显示地址为则为也就是对应的第一个入参对应现场显示地址为因此如果第一次进来就异常的话那就是传进来的这个节点本身就存在问题需要查看上一级函数分析的来源从代码操作逻辑来看操作后为然后将该插入到红黑树上在中存在赋值操作循环退出的条件是或者为为则退出从异常反推的话那就是退出之后其的为而退出其中的中有一个为这里是基于管理的进行遍历树上的可能的一个已加入红黑树中的不可能为同时中的其他值是否全为无法判断基于现场分析的下一步调试思路如上异常均是来源于通用内核模块流程当前环境新增的操作是添加内核配置其功能本身稳定且流程不影响的流程现在从两个异常现场来源均和分配所需的管理节点相关一个是访问中的一个是访问中的链表元素且访问的元素均是因为空指针导致的后续访问异常在不怀疑内核代码逻辑异常的情况下很有可能是当前结构体内存被踩踏导致虽然最终现场都指向但调用的来源均来源于产品的一个驱动调用由于问题很容易出现因此我们可以添加打印更进一步确认出问题前的现场信息以及对应异常地址所在的物理地址或者虚拟地址查看其是否存在内存被踩的特征下一步思路对应现场一可以在这里获取前判断下里面的内容如果是则输出的内容信息以及所在的虚拟地址及页表情况添加的调试打印如下对于现场二我们在循环后添加值判断如果为则输出的地址及内容判断下然后全部内容也打印出来同时添加内核配置在异常时把涉及的可读寄存器地址前后字节内容打印下有利于分析是大片内存都异常还是单个值存在异常添加调试代码后复现分析通过添加打印对于现场一可以看到当前的地址和页表情况同时可以看到中的内容均为同时寄存器保存了所在地址通过配置添加的打印可以看出周围的内容全是零而一个初始化后也不可能全为因此这里基本可以确认是出现了内存被踩周围的内容同时查看多次复现的结果异常地址对应的物理地址都是固定物理地址为对应的最后一级页表项说明使用映射在页大小为虚拟地址为使用级页表情况下对应物理地址为基地址加偏移当前为对于的虚拟地址一般页表项中以上的都是页表相关的位低端的也是页表项的权限位信息真正存储物理地址的是这部分内容因此当前页表项所在的物理基地址为对应就是对应为当前虚拟地址对应物理地址则为查看为系统内存非预留内存踩内存问题分析从前面的分析信息我们可以认定异常内存是系统可用内存且和产品同事沟通这块内存基本不可能被硬件使用那暂时排除因为外设导致的直接物理内存踩踏配置后分析内核配置重新编译版本部署检测后内核输出如下告警信息从如上信息我们可以看出代码处出现了内存行为也就是访问了未分配的内存表示需要写的长度是对应进制为写的目的起始地址为写的任务是对应是任务后续打印出对应调用的堆栈回溯了当前页的情况同时基于的影子区域呈现相关内存的状态对于影子区域的数据进行分析根据中几个特征值的含义连续都可以访问连续可以访问连续都不能访问负数从上面值可以看出箭头所指的位置之后的地址都是的没有进行分配在地址之前的内存是全部可以正常的内存而当前写的起始地址是为因此最终写到因此可以说明该代码对应位置操作出现了个字节的越界写确定存在越界后使用查找指令地址对应代码流程对应访问操作代码为告警异常代码位置其中对应为从运行过程中的打印可以知道的值为因此为分析代码流程可以知道在每一次循环后会执行向后偏移以及清零动作如下因此随着循环的次数增加会越界到更多的位置从而导致出现一片内存被清空的情况问题解决产品将内存分配的大小从改成即的从改为修改后重新进行版本测试及原始版本测试没有告警出现对应内核访问非法地址问题也不在出现因此问题得到了解决经验总结基于当前问题分析过程针对此类问题总结内核内存越界问题定位思路首先对于内核内存越界情况目前主要存在两种场景一种是内核代码流程中代码编写错误导致越界踩踏内存另外一种场景则是硬件直接操作内存比如将内存踩踏但不管是哪种场景我们首先需要做的就是收集现场信息分析现场内核的内存越界一般最终的现场就是内核但现场一般是受害者需要首先分析受害者信息包括寄存器堆栈然后结合进行反汇编查看代码执行流程分析出现场变量成员的值情况判断变量是否存在多个变量值均异常比如全为或者不符合代码中变量的设置情况比如一个指针变量存储的不是一个正常的地址而看起来像码对于这些情况在异常有或者完整现场寄存器信息情况下可以进一步查看异常变量地址附近的值是否存在一定特征进而判断是否存在越界导致一片内存被踩本次故障我们就可以看到对应异常节点其结构体附近的内存全为如果有发现上述的不正常情况再分析导致异常的成员其物理地址情况分析其规律以及结合查看系统的物理内存地址分布分析驱动是否有可能访问这些内存来判断是否存在驱动在不预留内存的情况下对物理内存的直接访问如果判断存在多个值异常对应物理内存区间设备驱动不使用且异常地址的物理内存地址是系统可用内存对应当前属于第一种越界场景这种情况下的内存越界基本都可以使用工具在复现时检测出来目前内核内存越界检测主流的工具为和主要针对分配出来的内存用于检测这类内存的和问题如果异常的内存来源于分配的内存就可以使用这个功能功能只需要配置和这样就自动开启了的检测当然也可以在中指定手动开启检测针对系统管理的所有可见内存进行检测检测范围要比更广且可以利用其实现基本原理即对系统管理的所有内存进行影子区域映射管理每字节消耗内存进行记录对应消耗系统内存占用高版本优化只需要内存占用用于内存使用记录其主要定位系统内存和问题使用只需要内核配置和即可然后复现时就会输出类似如下告警对应会告诉我们越界的现场具体位置以及具体的越界地址再结合代码就可以精准定位该问题而对于第二种因为设备的直接内存访问导致的内存越界在我们通过异常的物理地址查看到设备有可能使用该内存的时候我们就可以进一步去分析相关的代码这种情况下没有手段去直接定位越界的代码但可以基于前面的异常现场分析获取可能的异常来源比如被踩内存中有类似报文的数据这种情况下我们可以进一步去分析网卡的行为延伸以上是基于一种出现异常后分析异常复现问题定位问题的思路我们可以看到其相对比较耗时如果问题偶现那即使有这样的手段也无法长时间复现该类问题同时虽好但很难商用其对单板内存占用的消耗以及内存访问上性能的影响使其只在开发阶段使用为此开源社区在性能和效率上进行平衡引入机制用于作为系统内存和问题的线上手段性能消耗小对系统影响低可以进行商用部署其通过采样形式进行检测虽然存在一定的几率遗漏检测但一旦检测到相关的越界异常其产生的效果就是不言而喻的目前已经支持后续如果出现访问越界便可以基于的告警信息进行问题定位同时总结内核异常分析基本步骤如下获取当前异常对应的内核代码的以及内核代码一般存放在内核编译生成路径的第一级目录下相当于是具备调试信息的内核镜像可以基于它分析内核代码的汇编执行流程将反汇编并重定向到文件中查看异常现场的指令寄存器比如显示当前指令是在函数偏移字节的位置该函数大小为个字节不同架构的指令寄存器命名稍有区别对应为对于为我们需要结合和内核代码去确定当前指令具体的执行代码操作在中找到异常现场指令寄存器显示的函数首先需要查看中函数的大小是否和异常现场显示的函数大小一致目的是为了确保我们后续对的解读是和该异常的内核是完全对应的找到中对应偏移的指令地址查看指令执行的动作比如操作的寄存器举例我们可以看到当前指令地址是当前指令是这是指令机器码对应其汇编代码为表示将访问地址所在内容并将内容赋值给寄存器利用查看当前指令所在的代码通过如下命令进行就可以获取这条指令所在的代码行这样我们就能从代码逻辑上去进一步分析当前操作的是哪个变量执行这个操作的目的是做什么不同架构汇编指令存在差异以下列举常用的几个架构对应指令方便有不熟悉的指令可以去搜索转汇编超级大熊博客园汇编指令集汇编命令的博客博客后续分析就是结合代码和反汇编反复进行第五步从异常位置一步步往前推结合异常现场输出的各个寄存器内容来进一步推出最早就存在异常的结构体变量来判断到底是哪个地方出现了问题以及后续如果需要调试的话需要知道什么才可以进一步分析问题这些就需要具体问题具体分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-28 16:22:11',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">远辰</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/DPDK/" style="font-size: 1.05rem;">DPDK<sup>3</sup></a><a href="/tags/ONOS/" style="font-size: 1.05rem;">ONOS<sup>1</sup></a><a href="/tags/algorithm/" style="font-size: 1.05rem;">algorithm<sup>1</sup></a><a href="/tags/blockchain/" style="font-size: 1.05rem;">blockchain<sup>1</sup></a><a href="/tags/c/" style="font-size: 1.05rem;">c<sup>1</sup></a><a href="/tags/configuration/" style="font-size: 1.05rem;">configuration<sup>1</sup></a><a href="/tags/container/" style="font-size: 1.05rem;">container<sup>26</sup></a><a href="/tags/go/" style="font-size: 1.05rem;">go<sup>14</sup></a><a href="/tags/kidgets/" style="font-size: 1.05rem;">kidgets<sup>3</sup></a><a href="/tags/linux/" style="font-size: 1.05rem;">linux<sup>41</sup></a><a href="/tags/network/" style="font-size: 1.05rem;">network<sup>9</sup></a><a href="/tags/pppoe/" style="font-size: 1.05rem;">pppoe<sup>1</sup></a><a href="/tags/rust/" style="font-size: 1.05rem;">rust<sup>6</sup></a><a href="/tags/sdn/" style="font-size: 1.05rem;">sdn<sup>4</sup></a><a href="/tags/systemtap/" style="font-size: 1.05rem;">systemtap<sup>4</sup></a><a href="/tags/tools/" style="font-size: 1.05rem;">tools<sup>1</sup></a><a href="/tags/tvbox/" style="font-size: 1.05rem;">tvbox<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">December 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">November 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">October 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">July 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">June 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">May 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">April 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">March 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"><a class="article-meta__tags" href="/tags/linux/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>linux</span></a></span></div></div><h1 class="post-title" itemprop="name headline">部署ftrace出现内存越界</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-05-19T07:07:00.000Z" title="发表于 2023-05-19 15:07:00">2023-05-19</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-09-28T08:22:11.107Z" title="更新于 2023-09-28 16:22:11">2023-09-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/"><header><a href="/tags/linux/" tabindex="-1" itemprop="url">linux</a><h1 id="CrawlerTitle" itemprop="name headline">部署ftrace出现内存越界</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">哪吒藕霸</span><time itemprop="dateCreated datePublished" datetime="2023-05-19T07:07:00.000Z" title="发表于 2023-05-19 15:07:00">2023-05-19</time><time itemprop="dateCreated datePublished" datetime="2023-09-28T08:22:11.107Z" title="更新于 2023-09-28 16:22:11">2023-09-28</time></header><h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1.引言"></a>1.引言</h2><p>本文分析一起由内存越界导致的内核 oops 问题。先通过现场信息分析，确认问题是源于 vmalloc 子系统管理的链表和红黑树中出现了不正常的空节点；然后再添加调试信息，确认了现场的空节点是内存被踩导致；之后复现问题，分析告警信息，最终定位问题来源于产品驱动代码存在越界写操作。</p>
<p>虽然问题由部署<code>ftrace</code>功能引起，但本质该问题是由于产品代码存在内存越界操作导致，ftrace 的部署使得内存使用发生变化，将问题触发出来。如果没有进行 ftrace 的部署操作和问题定位，在外场极有可能引发偶现内核 bug，且该类内存越界问题很难快速定位，影响较大。</p>
<p>下面就具体问题进行描述，其内容包括问题背景，现场分析，如何判断是内存越界问题以及对于该类内存越界如何进行排查分析。</p>
<h2 id="2-问题背景"><a href="#2-问题背景" class="headerlink" title="2. 问题背景"></a>2. 问题背景</h2><p>某产品需要部署 ftrace 功能用于故障动态分析，在其内核配置 ftrace 功能之后，基本必现内核访问非法地址异常，其异常主要有两种现场。</p>
<h2 id="3-问题分析"><a href="#3-问题分析" class="headerlink" title="3. 问题分析"></a>3. 问题分析</h2><p>对于内核出现 oops 异常，我们首先需要做的就是分析现场，查看出现问题的直接原因，基于此再做下一步的判断。如下我们针对提供的两个异常现场分别进行分析。</p>
<h3 id="3-1-现场一分析"><a href="#3-1-现场一分析" class="headerlink" title="3.1 现场一分析"></a>3.1 现场一分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[   42.951896] Unable to handle kernel paging request at virtual address ffffffffffffffd0  </span><br><span class="line">[   42.959867] Mem abort info:  </span><br><span class="line">[   42.962670]   ESR = 0x96000004  </span><br><span class="line">[   42.965740]   Exception (current EL), IL = 32 bits  </span><br><span class="line">[   42.971696]   SET = 0, FnV = 0  </span><br><span class="line">[   42.974763]   EA = 0, S1PTW = 0  </span><br><span class="line">[   42.977920] Data abort info:  </span><br><span class="line">[   42.980810]   ISV = 0, ISS = 0x00000004  </span><br><span class="line">[   42.984666]   CM = 0, WnR = 0  </span><br><span class="line">[   42.987645] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____)  </span><br><span class="line">[   42.994564] [ffffffffffffffd0] pgd=0000000000000000  </span><br><span class="line">[   42.999474] Internal error: Oops: 96000004 [#1] PREEMPT SMP  </span><br><span class="line">[   43.005077] Modules linked in:  </span><br><span class="line">[   43.008145] Process swapper/0 (pid: 1, stack limit = 0x(____ptrval____))  </span><br><span class="line">[   43.014887] CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.19.82-rt30--test.10.R6.B2 #33  </span><br><span class="line">[   43.023201] Hardware name: LS1046A RDB Board (DT)  </span><br><span class="line">[   43.027929] pstate: 00000005 (nzcv daif -PAN -UAO)  </span><br><span class="line">[   43.032753] pc : alloc_vmap_area.isra.6+0x154/0x370  </span><br><span class="line">[   43.037657] lr : alloc_vmap_area.isra.6+0xb8/0x370  </span><br><span class="line">[   43.042472] sp : ffff00000803b8c0  </span><br><span class="line">[   43.045799] x29: ffff00000803b8c0 x28: 0000000000011000  </span><br><span class="line">[   43.051143] x27: ffffffffffff0000 x26: ffff000008000000  </span><br><span class="line">[   43.056486] x25: ffff0000090ba608 x24: ffff000008011000  </span><br><span class="line">[   43.061829] x23: ffff0000090ba000 x22: ffff7dffbfff0000  </span><br><span class="line">[   43.067172] x21: ffff000008000000 x20: 000000000000ffff  </span><br><span class="line">[   43.072515] x19: 0000000000010000 x18: ffffffffffffffff  </span><br><span class="line">[   43.077858] x17: 00000000c3ebdfe7 x16: 00000000bb9f9f45  </span><br><span class="line">[   43.083201] x15: ffff000008f58908 x14: 0000002000000020  </span><br><span class="line">[   43.088545] x13: 0000002000000020 x12: 0000002000000020  </span><br><span class="line">[   43.093888] x11: 0000002000000020 x10: 0000000000000000  </span><br><span class="line">[   43.099231] x9 : 0000000000000001 x8 : ffff000008f945d8  </span><br><span class="line">[   43.104574] x7 : 0000000000000000 x6 : 0000000000000003  </span><br><span class="line">[   43.109916] x5 : 0000000000000000 x4 : ffff00000821de38  </span><br><span class="line">[   43.115259] x3 : 0000000000000000 x2 : 0000000000011000  </span><br><span class="line">[   43.120602] x1 : 0000000000000000 x0 : 0000000000000000  </span><br><span class="line">[   43.125945] Call trace:  </span><br><span class="line">[   43.128399]  alloc_vmap_area.isra.6+0x154/0x370  </span><br><span class="line">[   43.132954]  __get_vm_area_node.isra.7+0xa4/0x198  </span><br><span class="line">[   43.137683]  get_vm_area_caller+0x54/0x68  </span><br><span class="line">[   43.141713]  __ioremap_caller+0x78/0x118  </span><br><span class="line">[   43.145654]  __ioremap+0x40/0x50  </span><br><span class="line">[   43.148898]  testA+0x108/0x418  </span><br><span class="line">[   43.152664]  testB+0x114/0x158  </span><br><span class="line">[   43.158180]  testC+0x48/0x58  </span><br><span class="line">[   43.162558]  bug_function+0x760/0x7e8  </span><br><span class="line">[   43.190933]  kernel_init+0x18/0x110  </span><br><span class="line">[   43.194438]  ret_from_fork+0x10/0x18  </span><br><span class="line">[   43.198029] Code: d503201f f9401800 eb08001f 54000940 (f85d0003)  </span><br><span class="line">[   43.204162] ---[ end trace 57f492af448f060a ]---  </span><br><span class="line">[   43.208803] Kernel panic - not syncing: Fatal exception  </span><br><span class="line">[   43.214057] SMP: stopping secondary CPUs  </span><br><span class="line">[   43.218004] ---[ end Kernel panic - not syncing: Fatal exception ]---</span><br></pre></td></tr></table></figure>

<p>异常现场记录指令寄存器为<code>pc : alloc_vmap_area.isra.6+0x154/0x370</code>， 其中异常指令为 alloc_vmap_area.isra.6 + 0x154 的位置，函数大小为 0x370。  </p>
<p>先使用命令反汇编 vmlinux 获取指令汇编内容<code>~/toolchains/aarch64_eabi_gcc6.2.0_glibc2.24.0_fp/bin/aarch64-unknown-linux-gnueabi-objdump -d vmlinux  &gt; vmlinux.log</code> ，确认 vmlinux.log 中 alloc_vmap_area.isra.6 函数大小为 0x370，之后查看异常指令位置和执行逻辑，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ffff00000821deb8:       5280000a        mov     w10, #0x0                       // #0  </span><br><span class="line">ffff00000821debc:       f9402047        ldr     x7, [x2,#64]  </span><br><span class="line">ffff00000821dec0:       1400000a        b       ffff00000821dee8 &lt;alloc_vmap_area.isra.6+0x168&gt;  </span><br><span class="line">ffff00000821dec4:       d503201f        nop  </span><br><span class="line">ffff00000821dec8:       f9401800        ldr     x0, [x0,#48]  </span><br><span class="line">ffff00000821decc:       eb08001f        cmp     x0, x8  </span><br><span class="line">ffff00000821ded0:       54000940        b.eq    ffff00000821dff8 &lt;alloc_vmap_area.isra.6+0x278&gt;  </span><br><span class="line">ffff00000821ded4:       f85d0003        ldur    x3, [x0,#-48]  //异常访问对应的指令</span><br></pre></td></tr></table></figure>

<p>对应异常指令为 ：<code>ffff00000821ded4:       f85d0003        ldur    x3, [x0,#-48] ，</code>可以看到其访问 x0 - 48 对应地址的内容，由于 x0 寄存器内容为 <code>x0 : 0000000000000000</code>，48 对应的 16 进制为 0x30，导致后续访问异常地址 0xffffffffffffffd0。输出<code>Unable to handle kernel paging request at virtual address ffffffffffffffd0</code>告警信息。</p>
<p>基于现有的 vmlinux，使用 addr2line 工具获取 <code>pc : alloc_vmap_area.isra.6+0x154/0x370</code> 指令对应的代码位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># aarch64-unknown-linux-gnueabi-addr2line -e vmlinux -i ffff00000821ded4  </span><br><span class="line">linux-4.19.x/mm/vmalloc.c:512</span><br></pre></td></tr></table></figure>

<p>对应代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> vmap_area *<span class="title function_">alloc_vmap_area</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> size,</span></span><br><span class="line"><span class="params">                                         <span class="type">unsigned</span> <span class="type">long</span> align,</span></span><br><span class="line"><span class="params">                                         <span class="type">unsigned</span> <span class="type">long</span> vstart, <span class="type">unsigned</span> <span class="type">long</span> vend,</span></span><br><span class="line"><span class="params">                                         <span class="type">int</span> node, <span class="type">gfp_t</span> gfp_mask)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> *<span class="title">va</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">n</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> addr;</span><br><span class="line">    <span class="type">int</span> purged = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> *<span class="title">first</span>;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">/* from the starting point, walk areas until a suitable hole is found */</span></span><br><span class="line">        <span class="keyword">while</span> (addr + size &gt; first-&gt;va_start &amp;&amp; addr + size &lt;= vend)</span><br><span class="line">    &#123; <span class="comment">// 异常指令位置</span></span><br><span class="line">        <span class="keyword">if</span> (addr + cached_hole_size &lt; first-&gt;va_start)</span><br><span class="line">            cached_hole_size = first-&gt;va_start - addr;</span><br><span class="line">        addr = ALIGN(first-&gt;va_end, align);</span><br><span class="line">        <span class="keyword">if</span> (addr + size &lt; addr)</span><br><span class="line">            <span class="keyword">goto</span> overflow;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list_is_last(&amp;first-&gt;<span class="built_in">list</span>, &amp;vmap_area_list))</span><br><span class="line">            <span class="keyword">goto</span> found;</span><br><span class="line"></span><br><span class="line">        first = list_next_entry(first, <span class="built_in">list</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从代码上看，这一行中进行地址访问只有 first-&gt;va_start，first 来源于 <code>list_next_entry(first, list)，</code>结合 first 为 <code>struct vmap_area</code>结构体指针，list 是 struct  vmap_area 的 0x30 偏移成员。struct  vmap_area 的结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> &#123;</span>  </span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> va_start;  </span><br><span class="line"> <span class="type">unsigned</span> <span class="type">long</span> va_end;  </span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb_node</span>;</span>         <span class="comment">/* address sorted rbtree */</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>          <span class="comment">/* address sorted list */</span> </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span> </span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> subtree_max_size; <span class="comment">/* in &quot;free&quot; tree */</span> </span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">vm_struct</span> *<span class="title">vm</span>;</span>           <span class="comment">/* in &quot;busy&quot; tree */</span> </span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> <span class="title">purge_list</span>;</span>   <span class="comment">/* in purge list */</span>  </span><br><span class="line"> &#125;;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因此代码是通过 list - 0x30 获取 first 的地址，然后在访问 first + 0x0 地址内容，也就是<code>struct vmap_area</code>结构体的第一个成员 va_start。对应到反汇编代码上，我们就可以知道当前 x0 是 first-&gt;list.next 的内容。这也就说明 vmap_area-&gt;list 链表里面 next 存储为 null 指针，而正常空链表里面的指针是指向自己所在地址，不会是 null。但其为空的原因，当前现场信息无法进行进一步排查。</p>
<h3 id="3-2-现场二分析"><a href="#3-2-现场二分析" class="headerlink" title="3.2 现场二分析"></a>3.2 现场二分析</h3><p>由于还存在另外一种异常，继续分析下一处异常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[   42.962934] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000008  </span><br><span class="line">[   42.971779] Mem abort info:  </span><br><span class="line">[   42.974582]   ESR = 0x96000004  </span><br><span class="line">[   42.977652]   Exception (current EL), IL = 32 bits  </span><br><span class="line">[   42.983609]   SET = 0, FnV = 0  </span><br><span class="line">[   42.986676]   EA = 0, S1PTW = 0  </span><br><span class="line">[   42.989835] Data abort info:  </span><br><span class="line">[   42.992725]   ISV = 0, ISS = 0x00000004  </span><br><span class="line">[   42.996582]   CM = 0, WnR = 0  </span><br><span class="line">[   42.999560] [0000000000000008] user address but active_mm is swapper  </span><br><span class="line">[   43.005955] Internal error: Oops: 96000004 [#1] PREEMPT SMP  </span><br><span class="line">[   43.011558] Modules linked in:  </span><br><span class="line">[   43.014627] Process swapper/0 (pid: 1, stack limit = 0x(____ptrval____))  </span><br><span class="line">[   43.021368] CPU: 2 PID: 1 Comm: swapper/0 Not tainted 4.19.82-rt30--test.10.R6.B2 #33  </span><br><span class="line">[   43.029682] Hardware name: LS1046A RDB Board (DT)  </span><br><span class="line">[   43.034411] pstate: a0000005 (NzCv daif -PAN -UAO)  </span><br><span class="line">[   43.039232] pc : rb_insert_color+0x10/0x1a0  </span><br><span class="line">[   43.043438] lr : __insert_vmap_area+0x78/0x128  </span><br><span class="line">[   43.047903] sp : ffff00000803b880  </span><br><span class="line">[   43.051230] x29: ffff00000803b880 x28: 0000000000011000  </span><br><span class="line">[   43.056574] x27: ffffffffffff0000 x26: ffff000008000000  </span><br><span class="line">[   43.061917] x25: ffff0000090ba608 x24: ffff000008011000  </span><br><span class="line">[   43.067261] x23: ffff0000090ba608 x22: ffff7dffbfff0000  </span><br><span class="line">[   43.072604] x21: ffff000008000000 x20: ffff80096f780298  </span><br><span class="line">[   43.077946] x19: ffff80096f780280 x18: ffffffffffffffff  </span><br><span class="line">[   43.083289] x17: 0000000004fc533b x16: 00000000ca1a36a0  </span><br><span class="line">[   43.088633] x15: ffff000008f58908 x14: 0000002000000020  </span><br><span class="line">[   43.093976] x13: 0000002000000020 x12: 0000002000000020  </span><br><span class="line">[   43.099319] x11: 0000002000000020 x10: 0000000000000000  </span><br><span class="line">[   43.104662] x9 : 0000000000000001 x8 : ffff000008f945d8  </span><br><span class="line">[   43.110005] x7 : 0000000000000000 x6 : 0000000000000003  </span><br><span class="line">[   43.115348] x5 : 0000000000000000 x4 : ffff00000821de38  </span><br><span class="line">[   43.120690] x3 : ffff80096f780098 x2 : 0000000000000000  </span><br><span class="line">[   43.126033] x1 : ffff0000090ba610 x0 : ffff80096f780298  </span><br><span class="line">[   43.131376] Call trace:  </span><br><span class="line">[   43.133830]  rb_insert_color+0x10/0x1a0  </span><br><span class="line">[   43.137684]  alloc_vmap_area.isra.6+0x328/0x370  </span><br><span class="line">[   43.142238]  __get_vm_area_node.isra.7+0xa4/0x198  </span><br><span class="line">[   43.146966]  get_vm_area_caller+0x54/0x68  </span><br><span class="line">[   43.150997]  __ioremap_caller+0x78/0x118  </span><br><span class="line">[   43.154938]  __ioremap+0x40/0x50  </span><br><span class="line">[   43.158181]  testA+0x108/0x418  </span><br><span class="line">[   43.161948]  testB+0x114/0x158  </span><br><span class="line">[   43.167464]  testC+0x48/0x58  </span><br><span class="line">[   43.171842]  bug_function+0x760/0x7e8  </span><br><span class="line">[   43.200216]  kernel_init+0x18/0x110  </span><br><span class="line">[   43.203720]  ret_from_fork+0x10/0x18  </span><br><span class="line">[   43.207312] Code: f9400003 b4000903 f9400062 37000ae2 (f9400444)  </span><br><span class="line">[   43.213446] ---[ end trace 1adba6c52b64a517 ]---  </span><br><span class="line">[   43.218086] Kernel panic - not syncing: Fatal exception  </span><br><span class="line">[   43.223339] SMP: stopping secondary CPUs  </span><br><span class="line">[   43.227286] ---[ end Kernel panic - not syncing: Fatal exception ]---</span><br></pre></td></tr></table></figure>

<p>对应现场 pc 为 <code>pc : rb_insert_color+0x10/0x1a0，</code>查看 vmlinux 中对应位置的反汇编指令为 <code>ffff000008a66ed0:       f9400444        ldr     x4, [x2,#8]</code>，对应是访问 x2 +8  的地址的内容，并赋值给 x4，可以看到现场x2 寄存器为 <code>x2 : 0000000000000000，</code>导致访问了异常地址并告警 <code>Unable to handle kernel NULL pointer dereference at virtual address 0000000000000008</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ffff000008a66ec0 &lt;rb_insert_color&gt;:  </span><br><span class="line">ffff000008a66ec0:       f9400003        ldr     x3, [x0] // x0 地址内容赋值给 x3  </span><br><span class="line">ffff000008a66ec4:       b4000903        cbz     x3, ffff000008a66fe4 &lt;rb_insert_color+0x124&gt; //判断 x3 是否为 null  </span><br><span class="line">ffff000008a66ec8:       f9400062        ldr     x2, [x3] // 把 x3 地址内容赋值给 x2  </span><br><span class="line">ffff000008a66ecc:       37000ae2        tbnz    w2, #0, ffff000008a67028 &lt;rb_insert_color+0x168&gt; //判断 w2 的第一位是否为 1  </span><br><span class="line">ffff000008a66ed0:       f9400444        ldr     x4, [x2,#8] // 异常指令 把 x2+8 地址内容赋值给 x4  </span><br><span class="line">ffff000008a66ed4:       b2400045        orr     x5, x2, #0x1  </span><br><span class="line">ffff000008a66ed8:       aa0203e7        mov     x7, x2  </span><br><span class="line">ffff000008a66edc:       eb03009f        cmp     x4, x3</span><br></pre></td></tr></table></figure>

<p>add2line 查看对应代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># aarch64-unknown-linux-gnueabi-addr2line -e vmlinux -i ffff00000821e0a4ffff000008a66ed0</span><br><span class="line"></span><br><span class="line">lib/rbtree.c:131  </span><br><span class="line">lib/rbtree.c:452</span><br></pre></td></tr></table></figure>

<p>对应代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">rb_insert_color</span><span class="params">(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_root *root)</span></span><br><span class="line">&#123;</span><br><span class="line">    __rb_insert(node, root, <span class="literal">false</span>, <span class="literal">NULL</span>, dummy_rotate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line">__rb_insert(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_root *root,</span><br><span class="line">            <span class="type">bool</span> newleft, <span class="keyword">struct</span> rb_node **leftmost,</span><br><span class="line">            <span class="type">void</span> (*augment_rotate)(<span class="keyword">struct</span> rb_node *old, <span class="keyword">struct</span> rb_node *new))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> rb_red_parent(node), *gparent, *tmp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newleft)</span><br><span class="line">        *leftmost = node;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (unlikely(!parent))</span><br><span class="line">        &#123;</span><br><span class="line">            rb_set_parent_color(node, <span class="literal">NULL</span>, RB_BLACK);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rb_is_black(parent))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        gparent = rb_red_parent(parent);</span><br><span class="line"></span><br><span class="line">        tmp = gparent-&gt;rb_right; <span class="comment">// 异常代码位置</span></span><br><span class="line"></span><br><span class="line">        <span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> rb_node *<span class="title function_">rb_red_parent</span><span class="params">(<span class="keyword">struct</span> rb_node * red)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">struct</span> rb_node *)red-&gt;__rb_parent_color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> __rb_parent_color;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_right</span>;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_left</span>;</span></span><br><span class="line">        &#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">long</span>))));</span><br></pre></td></tr></table></figure>



<p>rb_right 是 struct rb_node 结构体偏移 8 字节的成员，说明代码中的 gparent 为 NULL，也就是  parent-&gt;__rb_parent_color 变量为空指针，导致后续异常。前面执行 <code>rb_is_black(parent)</code> 只判断了 __rb_parent_color 的最后一位是否为 1，不判断空指针。</p>
<p>从代码流程上看，gparent 在第一次循环情况下，其 parent 来源于rb_red_parent(node)，对应 gparent &#x3D; node-&gt;__rb_parent_color-&gt;__rb_parent_color，根据汇编代码回溯 x2 寄存器的来源  <code>ffff000008a66ec8:       f9400062        ldr     x2, [x3]</code> 把 x3 地址存储的内容赋值给  x2，因此 x3 是 node-&gt;__rb_parent_color，对应现场显示 x3 地址为 <code>x3 : ffff80096f780098</code>，<code>ffff000008a66ec0:       f9400003        ldr     x3, [x0]</code>，x0 则为 node 也就是对应的第一个入参，对应现场显示 x0 地址为 <code>x0 : ffff80096f780298</code>。</p>
<p>因此如果第一次进来就异常的话，那就是传进来的 node-&gt;__rb_parent_color 这个节点本身就存在问题。需要查看上一级函数，分析 node-&gt;__rb_parent_color 的来源。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __insert_vmap_area(<span class="keyword">struct</span> vmap_area *va)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> =</span> &amp; vmap_area_root.rb_node;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*p)  &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> *<span class="title">tmp_va</span>;</span></span><br><span class="line"></span><br><span class="line">        parent = * p;</span><br><span class="line">        tmp_va = rb_entry(parent, <span class="keyword">struct</span> vmap_area, rb_node);</span><br><span class="line">        <span class="keyword">if</span></span><br><span class="line">             (va-&gt;va_start &lt; tmp_va-&gt;va_end)</span><br><span class="line">                p = &amp; (*p)-&gt;rb_left;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">             <span class="keyword">if</span>  (va-&gt;va_end &gt; tmp_va-&gt;va_start)</span><br><span class="line">                p = &amp; (*p)-&gt;rb_right;</span><br><span class="line">        <span class="keyword">else</span> BUG();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rb_link_node(&amp;va-&gt;rb_node, parent, p);</span><br><span class="line">    rb_insert_color(&amp;va-&gt;rb_node, &amp; vmap_area_root);</span><br></pre></td></tr></table></figure>

<p>从代码操作逻辑来看，rb_link_node 操作后  （&amp;va-&gt;rb_node） -&gt;__rb_parent_color 为 parent，然后 rb_insert_color 将该 （&amp;va-&gt;rb_node） 插入到 vmap_area_root 红黑树上， parent 在 while 中存在赋值操作，while 循环退出的条件是 rb_left 或者 rb_right 为 NULL，为NULL，while 则退出；</p>
<p>从异常反推的话，那就是 while 退出之后其 parent 的 __rb_parent_color 为 0，而 while 退出其 parent 中的 rb_left&#x2F;rb_right 中有一个为 0 。</p>
<p>这里是基于 vmalloc 管理的 vmap_area_root 进行遍历树上的可能的 rb_node， 一个已加入红黑树中 rb_node 的 __rb_parent_color  不可能为 0，同时 parent 中的其他值是否全为 0,无法判断。</p>
<h3 id="3-3-基于现场分析的下一步调试思路"><a href="#3-3-基于现场分析的下一步调试思路" class="headerlink" title="3.3 基于现场分析的下一步调试思路"></a>3.3 基于现场分析的下一步调试思路</h3><p>如上异常均是来源于通用内核模块流程，当前环境新增的操作是添加 ftrace 内核配置，其功能本身稳定，且流程不影响 vmalloc 的流程。现在从两个异常现场来源，均和 vmalloc 分配所需的管理节点相关，一个是访问 vmap_area_root.rb_node 中的 rb_node，一个是访问  vmap_area_list 中的链表元素，且访问的元素均是因为空指针导致的后续访问异常，在不怀疑内核代码逻辑异常的情况下，很有可能是当前结构体内存被踩踏导致。虽然最终现场 pc 都指向 vmalloc ，但调用的来源均来源于产品的一个驱动调用 bug_function。</p>
<p>由于问题很容易出现，因此我们可以添加打印，更进一步确认出问题前的现场信息，以及对应异常地址所在的物理地址或者虚拟地址，查看其是否存在内存被踩的特征。</p>
<p>下一步思路：</p>
<p>对应现场一，可以在这里获取 first 前判断下 first 里面的内容，如果是 null ，则输出 first 的内容信息，以及 first 所在的虚拟地址及页表情况。添加的调试打印如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (addr + size &gt; first-&gt;va_start &amp;&amp; addr + size &lt;= vend) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr + cached_hole_size &lt; first-&gt;va_start)</span><br><span class="line">        cached_hole_size = first-&gt;va_start - addr;</span><br><span class="line">    addr = ALIGN(first-&gt;va_end, align);</span><br><span class="line">    <span class="keyword">if</span> (addr + size &lt; addr) <span class="keyword">goto</span> overflow;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list_is_last(&amp;first-&gt;<span class="built_in">list</span>, &amp; vmap_area_list)) <span class="keyword">goto</span> found;</span><br><span class="line">    +    <span class="keyword">if</span> ( first-&gt;<span class="built_in">list</span>.next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    +      printk(<span class="string">&quot;*** BUG! the list is null first %lx, list.next %lx, list.prev %lx \n&quot;</span>, first, first-&gt;<span class="built_in">list</span>.next, first-&gt;<span class="built_in">list</span>.prev);</span><br><span class="line">    +      show_pte(first);</span><br><span class="line">    +    </span><br><span class="line">    + &#125;</span><br><span class="line">    first = list_next_entry(first, <span class="built_in">list</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于现场二，我们在 while 循环后添加 __rb_parent_color  NULL 值判断，如果为 NULL，则输出 parent 的地址及内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __insert_vmap_area(<span class="keyword">struct</span> vmap_area *va)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span> =</span> &amp;vmap_area_root.rb_node;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*p) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> *<span class="title">tmp_va</span>;</span></span><br><span class="line"></span><br><span class="line">        parent = *p;</span><br><span class="line">        tmp_va = rb_entry(parent, <span class="keyword">struct</span> vmap_area, rb_node);</span><br><span class="line">        <span class="keyword">if</span> (va-&gt;va_start &lt; tmp_va-&gt;va_end)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (va-&gt;va_end &gt; tmp_va-&gt;va_start)</span><br><span class="line">            p = &amp;(*p)-&gt;rb_right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            BUG();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>&#x2F;&#x2F;判断下 parent-&gt;__rb_parent_color ,然后 show_pte，全部内容也打印出来。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">+    if(parent-&gt;__rb_parent_color == NULL)&#123;  </span><br><span class="line">+     printk(&quot;BUG! rb_node entry is null %lx\n&quot;,parent);  </span><br><span class="line">+     printk(&quot;BUG! rb_node parent is %lx, right %lx, left %lx\n&quot;,parent-&gt;__rb_parent_color, parent-&gt;rb_right, parent-&gt;rb_left);  </span><br><span class="line">+     show_pte(parent);  </span><br><span class="line">+    &#125;  </span><br><span class="line"> rb_link_node(&amp;va-&gt;rb_node, parent, p);  </span><br><span class="line"> rb_insert_color(&amp;va-&gt;rb_node, &amp;vmap_area_root); </span><br></pre></td></tr></table></figure>

<p>同时添加内核配置  CONFIG_SHOW_EXTRA_REGISTER_DATA，在异常时，把涉及的可读寄存器地址前后 128字节 内容打印下，有利于分析是大片内存都异常还是单个值存在异常。</p>
<h3 id="3-4-添加调试代码后复现分析"><a href="#3-4-添加调试代码后复现分析" class="headerlink" title="3.4 添加调试代码后复现分析"></a>3.4 添加调试代码后复现分析</h3><p>通过添加打印，对于现场一， 可以看到 first 当前的地址和页表情况，同时可以看到 first-&gt;list 中的内容均为 0，同时 x6 寄存器保存了 first 所在地址，通过 CONFIG_SHOW_EXTRA_REGISTER_DATA 配置添加的打印，可以看出 first&#x3D; 0xffff80096f780080 周围的内容全是零。而一个 first 初始化后，也不可能全为 0，因此这里基本可以确认是出现了内存被踩。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[   42.944137] *** BUG! the list is null first ffff80096f780080, list.next 0, list.prev 0 </span><br><span class="line">[   42.952197] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____) </span><br><span class="line">[   42.959116] [ffff80096f780080] pgd=00000009fbdf8003, pud=00000009fbdf4003, pmd=00780009ef600711 </span><br><span class="line">[   42.967882] Unable to handle kernel paging request at virtual address ffffffffffffffd0 </span><br><span class="line">[   42.975851] Mem abort info: </span><br><span class="line">[   42.978654]   ESR = 0x96000004 </span><br><span class="line">[   42.981724]   Exception (current EL), IL = 32 bits </span><br><span class="line">[   42.987680]   SET = 0, FnV = 0 </span><br><span class="line">[   42.990744]   EA = 0, S1PTW = 0 </span><br><span class="line">[   42.993901] Data abort info: </span><br><span class="line">[   42.996791]   ISV = 0, ISS = 0x00000004 </span><br><span class="line">[   43.000648]   CM = 0, WnR = 0 </span><br><span class="line">[   43.003626] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____) </span><br><span class="line">[   43.010545] [ffffffffffffffd0] pgd=0000000000000000 </span><br><span class="line">[   43.015454] Internal error: Oops: 96000004 [#1] PREEMPT SMP </span><br><span class="line">[   43.021057] Modules linked in: </span><br><span class="line">[   43.024125] Process swapper/0 (pid: 1, stack limit = 0x(____ptrval____)) </span><br><span class="line">[   43.030867] CPU: 3 PID: 1 Comm: swapper/0 Not tainted 4.19.82-rt30--test.10.R6.B2 #36 </span><br><span class="line">[   43.039181] Hardware name: LS1046A RDB Board (DT) </span><br><span class="line">[   43.043909] pstate: 80000005 (Nzcv daif -PAN -UAO) </span><br><span class="line">[   43.048733] pc : alloc_vmap_area.isra.6+0x150/0x398 </span><br><span class="line">[   43.053637] lr : alloc_vmap_area.isra.6+0x374/0x398 </span><br><span class="line">[   43.058538] sp : ffff00000803b890 </span><br><span class="line">[   43.061866] x29: ffff00000803b890 x28: 0000000000011000 </span><br><span class="line">[   43.067210] x27: ffffffffffff0000 x26: ffff000008000000 </span><br><span class="line">[   43.072553] x25: ffff0000090ba608 x24: ffff000008011000 </span><br><span class="line">[   43.077896] x23: ffff0000090ba000 x22: ffff7dffbfff0000 </span><br><span class="line">[   43.083239] x21: ffff000008000000 x20: 000000000000ffff </span><br><span class="line">[   43.088583] x19: 0000000000010000 x18: ffffffffffffffff </span><br><span class="line">[   43.093926] x17: 00000000f169a1c5 x16: 000000006ffdbbec </span><br><span class="line">[   43.099269] x15: ffff000008f58908 x14: 303d646d70202c33 </span><br><span class="line">[   43.104612] x13: 3030346664626639 x12: ffff000008d15a28 </span><br><span class="line">[   43.109955] x11: ffff000008f945d8 x10: 3866646266393030 </span><br><span class="line">[   43.115298] x9 : 30303030303d6467 x8 : 70205d3038303038 </span><br><span class="line">[   43.120641] x7 : 3766363930303866 x6 : ffff80096f780080 </span><br><span class="line">[   43.125984] x5 : 0000000000011000 x4 : 0000000000000000 </span><br><span class="line">[   43.131327] x3 : 0000000000000000 x2 : 872c9612bac87600 </span><br><span class="line">[   43.136670] x1 : 0000000000000000 x0 : 0000000000000000 </span><br><span class="line">[   43.142013] show regs info </span><br><span class="line">[   43.144727] ! user_mode </span><br><span class="line">[   43.147180] show extra register data </span><br><span class="line">[   43.150772] </span><br><span class="line">[   43.150772] X6: 0xffff80096f780000: </span><br><span class="line">[   43.155766] 0000  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.163995] 0020  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.172223] 0040  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.180452] 0060  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.188681] 0080  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.196910] 00a0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.205138] 00c0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.213367] 00e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">[   43.221597] </span><br><span class="line">[   43.221597] X27: 0xfffffffffffeff80: </span><br><span class="line">[   43.226680] ff80  ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.234910] ffa0 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.243141] ffc0 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.251371] ffe0 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.259601] 0000 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.267832] 0020 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.276062] 0040 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.284293] 0060 ******** ******** ******** ******** ******** ******** ******** ********  </span><br><span class="line">[   43.292519] Call trace:  </span><br><span class="line">[   43.294973]  alloc_vmap_area.isra.6+0x150/0x398  </span><br><span class="line">[   43.299528]  __get_vm_area_node.isra.7+0xa4/0x198  </span><br><span class="line">[   43.304256]  get_vm_area_caller+0x54/0x68  </span><br><span class="line">[   43.308286]  __ioremap_caller+0x78/0x118  </span><br><span class="line">[   43.312228]  __ioremap+0x40/0x50  </span><br><span class="line">[   43.158181]  testA+0x108/0x418  </span><br><span class="line">[   43.161948]  testB+0x114/0x158  </span><br><span class="line">[   43.167464]  testC+0x48/0x58  </span><br><span class="line">[   43.357506]  kernel_init+0x18/0x110  </span><br><span class="line">[   43.361010]  ret_from_fork+0x10/0x18  </span><br><span class="line">[   43.364602] Code: f94018c0 eb0b001f 540007a0 b4000fe0 (f85d0001)  </span><br><span class="line">[   43.370735] ---[ end trace 5981024bcfcf5691 ]---  </span><br><span class="line">[   43.375375] Kernel panic - not syncing: Fatal exception  </span><br><span class="line">[   43.380629] SMP: stopping secondary CPUs  </span><br><span class="line">[   43.384576] ---[ end Kernel panic - not syncing: Fatal exception ]---</span><br></pre></td></tr></table></figure>

<p>first&#x3D; 0xffff80096f780080 周围的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[   43.150772] X6: 0xffff80096f780000:  </span><br><span class="line">[   43.155766] 0000  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.163995] 0020  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.172223] 0040  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.180452] 0060  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.188681] 0080  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.196910] 00a0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.205138] 00c0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000  </span><br><span class="line">[   43.213367] 00e0  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>

<p>同时查看多次复现的结果，异常地址 show_pte 对应的物理地址都是固定物理地址，pmd 为对应的最后一级页表项，说明使用 section 映射，在页大小为 4k，虚拟地址为 48bit 使用 4 级页表情况下，对应物理地址为基地址加偏移，当前 pmd 为 pmd&#x3D;00780009ef600711，对于 48 bit 的虚拟地址，一般页表项中 48 bit 以上的都是页表相关的 flag 位，低端的 12bit 也是页表项的权限位信息，真正存储物理地址的是，12-48 bit 这部分内容，因此当前页表项所在的物理基地址为 0000 0009ef600 000，对应就是 0x9ef600000，对应为当前虚拟地址对应物理地址则为 9ef600000 + (ffff80096f780080 &amp; (1&lt;&lt;21 -1)) &#x3D; 9ef780080。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[   42.944137] *** BUG! the list is null first ffff80096f780080, list.next 0, list.prev 0  </span><br><span class="line">[   42.952197] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____)  </span><br><span class="line">[   42.959116] [ffff80096f780080] pgd=00000009fbdf8003, pud=00000009fbdf4003, pmd=00780009ef600711   </span><br><span class="line">[   42.967882] Unable to handle kernel paging request at virtual address ffffffffffffffd0</span><br><span class="line"></span><br><span class="line">[   42.938740] *** BUG! the list is null first ffff80096f780080, list.next 0, list.prev 0  </span><br><span class="line">[   42.946800] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____)  </span><br><span class="line">[   42.953719] [ffff80096f780080] pgd=00000009fbdf8003, pud=00000009fbdf4003, pmd=00780009ef600711  </span><br><span class="line">[   42.962485] Unable to handle kernel paging request at virtual address ffffffffffffffd0</span><br><span class="line"></span><br><span class="line">[   42.942640] *** BUG! the list is null first ffff80096f780080, list.next 0, list.prev 0  </span><br><span class="line">[   42.950701] swapper pgtable: 4k pages, 48-bit VAs, pgdp = (____ptrval____)  </span><br><span class="line">[   42.957621] [ffff80096f780080] pgd=00000009fbdf8003, pud=00000009fbdf4003, pmd=00780009ef600711  </span><br><span class="line">[   42.966388] Unable to handle kernel paging request at virtual address ffffffffffffffd0</span><br></pre></td></tr></table></figure>

<p>查看 &#x2F;proc&#x2F;iomem ，9ef780080 为系统内存 System RAM，非预留内存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">880000000-9fbdfffff : System RAM  </span><br><span class="line"> 9ef800000-9fb7fffff : reserved  </span><br><span class="line"> 9fb907000-9fbdcefff : reserved  </span><br><span class="line"> 9fbdd1000-9fbdd2fff : reserved  </span><br><span class="line"> 9fbdd3000-9fbdd3fff : reserved  </span><br><span class="line"> 9fbdd4000-9fbdd6fff : reserved  </span><br><span class="line"> 9fbdd7000-9fbdfefff : reserved  </span><br><span class="line"> 9fbdff000-9fbdfffff : reserved</span><br></pre></td></tr></table></figure>

<h3 id="3-5-踩内存问题分析"><a href="#3-5-踩内存问题分析" class="headerlink" title="3.5 踩内存问题分析"></a>3.5 踩内存问题分析</h3><p>从前面的分析信息，我们可以认定异常内存是系统可用内存，且和产品 bsp 同事沟通，这块内存基本不可能被硬件使用，那暂时排除因为外设导致的直接物理内存踩踏。</p>
<h3 id="3-6-配置-kasan-后分析"><a href="#3-6-配置-kasan-后分析" class="headerlink" title="3.6 配置 kasan 后分析"></a>3.6 配置 kasan 后分析</h3><p>内核配置 CONFIG_KASAN, 重新编译版本，部署 kasan 检测后，内核输出如下告警信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[   22.680008] index[1] fpgasize[0x1701e4c],fpgaoff[0xae9dfc].  </span><br><span class="line">[   22.685624] Load func: Secondary  </span><br><span class="line">[   22.688956] Begin load fpga!  </span><br><span class="line">[   22.706606] ==================================================================  </span><br><span class="line">[   22.713939] BUG: KASAN: use-after-free in bug_function+0x958/0xa98  </span><br><span class="line">[   22.720946] Write of size 262148 at addr ffff80092f7c0004 by task swapper/0/1  </span><br><span class="line">[   22.728126]  </span><br><span class="line">[   22.729624] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.19.82-rt30--test.10.R6.B2 #38  </span><br><span class="line">[   22.737942] Hardware name: LS1046A RDB Board (DT)  </span><br><span class="line">[   22.742673] Call trace:  </span><br><span class="line">[   22.745133]  dump_backtrace+0x0/0x298  </span><br><span class="line">[   22.748816]  show_stack+0x24/0x30  </span><br><span class="line">[   22.752152]  dump_stack+0x98/0xbc  </span><br><span class="line">[   22.755487]  print_address_description+0x68/0x258  </span><br><span class="line">[   22.760220]  kasan_report+0x24c/0x358  </span><br><span class="line">[   22.763903]  check_memory_region+0x14c/0x1c0  </span><br><span class="line">[   22.768198]  memcpy+0x48/0x68  </span><br><span class="line">[   22.771183]  bug_function+0x958/0xa98  </span><br><span class="line">[   22.775654]  testE+0x43c/0x6b0  </span><br><span class="line">[   22.780126]  testF+0x1e4/0x220  </span><br><span class="line">[   22.799597]  kernel_init+0x18/0x120  </span><br><span class="line">[   22.803106]  ret_from_fork+0x10/0x1c  </span><br><span class="line">[   22.806700]  </span><br><span class="line">[   22.808193] The buggy address belongs to the page:  </span><br><span class="line">[   22.813014] page:ffff7e0024bdf000 count:1 mapcount:0 mapping:0000000000000000 index:0x0  </span><br><span class="line">[   22.821074] flags: 0x4000000000000000()  </span><br><span class="line">[   22.824935] raw: 4000000000000000 dead000000000100 dead000000000200 0000000000000000  </span><br><span class="line">[   22.832731] raw: 0000000000000000 0000000000000000 00000001ffffffff 0000000000000000  </span><br><span class="line">[   22.840524] page dumped because: kasan: bad access detected  </span><br><span class="line">[   22.846128]  </span><br><span class="line">[   22.847622] Memory state around the buggy address:  </span><br><span class="line">[   22.852443]  ffff80092f7fff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.859713]  ffff80092f7fff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.866983] &gt;ffff80092f800000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.874251]                    ^  </span><br><span class="line">[   22.877496]  ffff80092f800080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.884766]  ffff80092f800100: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.892034] ==================================================================  </span><br><span class="line">[   22.899301] Disabling lock debugging due to kernel taint  </span><br><span class="line">[   22.905563] ioremap phy addr 2100000 size 10000  </span><br><span class="line">[   22.910151] ioremap phy addr 2100000 size 10000 to virt addr ffff20000a4d0000</span><br></pre></td></tr></table></figure>

<p>从如上信息我们可以看出， bug_function+0x958&#x2F;0xa98 代码处出现了 use-after-free 内存行为，也就是访问了未分配的内存； Write of size 262148 at addr ffff80092f7c0004 by task swapper&#x2F;0&#x2F;1 表示需要写的长度是 262148，对应 16进制为 0x40004，写的目的起始地址为 0xffff80092f7c0004，写的任务是 swapper&#x2F;0&#x2F;1,对应是 idle 任务。 后续打印出对应调用的堆栈，回溯了当前页的 struct page 情况。</p>
<p>同时基于 kasan 的影子区域呈现相关内存的状态，对于影子区域的数据进行分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[   22.847622] Memory state around the buggy address:  </span><br><span class="line">[   22.852443]  ffff80092f7fff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.859713]  ffff80092f7fff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.866983] &gt;ffff80092f800000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.874251]                    ^  </span><br><span class="line">[   22.877496]  ffff80092f800080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span><br></pre></td></tr></table></figure>

<p>根据 kasan 中几个特征值的含义</p>
<p> 连续 8 byte 都可以访问 &#x3D;&#x3D;&gt; shadow memory &#x3D; 0<br> 连续 N(1 &lt;&#x3D; N &lt;&#x3D; 7) byte 可以访问 &#x3D;&#x3D;&gt; shadow memory &#x3D; N<br> 连续 8 byte 都不能访问 &#x3D;&#x3D;&gt; shadow memory &#x3D; 负数  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KASAN_FREE_PAGE   0xFF <span class="comment">/* page was freed */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASAN_PAGE_REDZONE  0xFE <span class="comment">/* redzone for kmalloc_large alloctions */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASAN_KMALLOC_REDZONE 0xFC <span class="comment">/* red zone inside slub object */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASAN_KMALLOC_FREE  0xFB <span class="comment">/* object was freed(kmem_cache_free/kfree) */</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASAN_GLOBAL_REDZONE 0xFA / * redzone for global variable */</span></span><br></pre></td></tr></table></figure>

<p>从上面 kasan 值可以看出，箭头所指的位置，ffff80092f800000 之后的地址都是 freed 的，没有进行分配；在 ffff80092f800000 地址之前的内存是全部可以正常的内存，而当前写的起始地址是 0xffff80092f7c0004,size 为 0x40004，因此最终写到 0xffff80092f800008。因此可以说明该代码对应位置操作出现了 8 个字节的越界写。</p>
<p>确定存在越界后，使用 addr2line 查找指令地址对应代码流程，对应访问操作代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fpgasize / BUFFER_IN) &#123;</span><br><span class="line">    addr_off = fpgaoff % <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(ptBuffer, (UINT8 *)(viraddr + <span class="number">0x20</span> + fpgaoff - addr_off),</span><br><span class="line">           (BUFFER_IN + addr_off)); <span class="comment">// KASAN 告警 PC 异常代码位置</span></span><br><span class="line">    ptBuffer = ptBuffer + addr_off;</span><br><span class="line">    ulRet = test_function(&amp;pFuncProcess, ptBuffer, BUFFER_IN, SUNZIP_MIDDLE);</span><br><span class="line">    <span class="keyword">if</span> (ulRet) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptBuffer, <span class="number">0</span>, BUFFER_IN);</span><br><span class="line">    fpgasize -= BUFFER_IN;</span><br><span class="line">    fpgaoff += BUFFER_IN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中对应 ptBuffer 为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptBuffer = (UINT8*)__get_free_pages(GFP_KERNEL,<span class="number">6</span>);  </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_IN (1024*256)</span></span><br></pre></td></tr></table></figure>

<p>从运行过程中的打印，可以知道 fpgaoff 的值为 0xae9dfc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[   22.659785] index[1] fpgasize[0x1701e4c],fpgaoff[0xae9dfc].</span><br></pre></td></tr></table></figure>

<p>因此 addr_off 为 0x4；</p>
<p>分析代码流程可以知道 ptBuffer 在每一次循环后会执行向后偏移 addr_off 以及清零动作，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ptBuffer = ptBuffer+addr_off;</span><br><span class="line"><span class="built_in">memset</span>(ptBuffer, <span class="number">0</span>, BUFFER_IN);</span><br></pre></td></tr></table></figure>

<p>因此随着循环的次数增加，ptBuffer 会越界到更多的位置。从而导致出现一片内存被清空的情况。</p>
<h3 id="3-7-问题解决"><a href="#3-7-问题解决" class="headerlink" title="3.7 问题解决"></a>3.7 问题解决</h3><p>产品将 ptBuffer 内存分配的大小从 256k 改成  512k，即 get_free_pages 的 order 从 6 改为 7。修改后，重新进行 kasan 版本测试及原始版本测试，没有 kasan 告警出现，对应内核访问非法地址问题也不在出现。因此问题得到了解决。</p>
<h2 id="4-经验总结"><a href="#4-经验总结" class="headerlink" title="4. 经验总结"></a>4. 经验总结</h2><p>基于当前问题分析过程，针对此类问题，总结内核内存越界问题定位思路：</p>
<p>首先对于内核内存越界情况，目前主要存在两种场景，一种是内核代码流程中代码编写错误，导致越界踩踏内存；另外一种场景则是硬件直接操作内存，比如 dma，将内存踩踏。但不管是哪种场景，我们首先需要做的就是收集现场信息。</p>
<ol>
<li><p>分析 oops 现场。内核的内存越界，一般最终的现场就是内核 oops，但现场一般是受害者，需要首先分析受害者信息，包括寄存器，pc，堆栈，然后结合 vmlinux 进行反汇编，查看代码执行流程，分析出现场变量成员的值情况；</p>
</li>
<li><p>判断变量是否存在多个变量值均异常，比如全为 NULL，或者不符合代码中变量的设置情况；比如一个指针变量存储的不是一个正常的地址，而看起来像 ASCII 码。对于这些情况，在异常有 vmcore 或者完整现场寄存器信息情况下，可以进一步查看异常变量地址附近的值，是否存在一定特征，进而判断是否存在越界导致一片内存被踩，本次故障我们就可以看到对应异常节点其结构体附近的内存全为 0。</p>
</li>
<li><p>如果有发现上述的不正常情况，再分析导致异常的成员其物理地址情况，分析其规律，以及结合  &#x2F;proc&#x2F;iomem 查看系统的物理内存地址分布，分析驱动是否有可能访问这些内存，来判断是否存在驱动在不预留内存的情况下，对物理内存的直接访问。</p>
</li>
</ol>
<p>如果判断存在多个值异常，对应物理内存区间设备驱动不使用，且异常地址的物理内存地址是系统可用内存，对应当前属于第一种越界场景，这种情况下的内存越界基本都可以使用工具在复现时检测出来。目前内核内存越界检测主流的工具为  KASAN 和 slub_debug 。</p>
<p>slub_debug 主要针对 slub 分配出来的内存，用于检测这类内存的 ues-after-free 和 out-of-bounds 问题。如果异常的内存来源于  slab 分配的内存，就可以使用这个功能，功能只需要配置 CONFIG_SLUB_DEBUG&#x3D;y 和 CONFIG_SLUB_DEBUG_ON&#x3D;y 这样就自动开启了 slub_debug 的检测，当然也可以在 cmdline 中指定 slub_debug 手动开启检测。</p>
<p>KASAN (Kernel Address SANitizer) 针对系统管理的所有可见内存进行检测，检测范围要比 slub_debug 更广，且可以利用 slub_debug。其实现基本原理即对系统管理的所有内存进行影子区域映射管理，每 8 字节消耗 8 bit 内存进行记录，对应消耗 系统 1&#x2F;8 内存占用（高版本 KASAN 优化只需要 1&#x2F;16 内存占用），用于内存使用记录。其主要定位系统内存 ues-after-free 和 out-of-bounds 问题，使用 KASAN 只需要内核配置 CONFIG_SLUB_DEBUG&#x3D;y 和 CONFIG_KASAN&#x3D;y 即可。然后复现时，就会输出类似如下告警：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[   22.706606] ==================================================================  </span><br><span class="line">[   22.713939] BUG: KASAN: use-after-free in bug_function+0x958/0xa98  </span><br><span class="line">[   22.720946] Write of size 262148 at addr ffff80092f7c0004 by task swapper/0/1  </span><br><span class="line">[   22.728126]  </span><br><span class="line">[   22.729624] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.19.82-rt30--test.10.R6.B2 #38  </span><br><span class="line">[   22.737942] Hardware name: LS1046A RDB Board (DT)  </span><br><span class="line">[   22.742673] Call trace:  </span><br><span class="line">[   22.745133]  dump_backtrace+0x0/0x298  </span><br><span class="line">[   22.748816]  show_stack+0x24/0x30  </span><br><span class="line">[   22.752152]  dump_stack+0x98/0xbc  </span><br><span class="line">[   22.755487]  print_address_description+0x68/0x258  </span><br><span class="line">[   22.760220]  kasan_report+0x24c/0x358  </span><br><span class="line">[   22.763903]  check_memory_region+0x14c/0x1c0  </span><br><span class="line">[   22.768198]  memcpy+0x48/0x68  </span><br><span class="line">[   22.771183]  bug_function+0x958/0xa98  </span><br><span class="line">[   22.775654]  testE+0x43c/0x6b0  </span><br><span class="line">[   22.780126]  testF+0x1e4/0x220  </span><br><span class="line">[   22.799597]  kernel_init+0x18/0x120  </span><br><span class="line">[   22.803106]  ret_from_fork+0x10/0x1c  </span><br><span class="line">[   22.806700]  </span><br><span class="line">[   22.808193] The buggy address belongs to the page:  </span><br><span class="line">[   22.813014] page:ffff7e0024bdf000 count:1 mapcount:0 mapping:0000000000000000 index:0x0  </span><br><span class="line">[   22.821074] flags: 0x4000000000000000()  </span><br><span class="line">[   22.824935] raw: 4000000000000000 dead000000000100 dead000000000200 0000000000000000  </span><br><span class="line">[   22.832731] raw: 0000000000000000 0000000000000000 00000001ffffffff 0000000000000000  </span><br><span class="line">[   22.840524] page dumped because: kasan: bad access detected  </span><br><span class="line">[   22.846128]  </span><br><span class="line">[   22.847622] Memory state around the buggy address:  </span><br><span class="line">[   22.852443]  ffff80092f7fff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.859713]  ffff80092f7fff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  </span><br><span class="line">[   22.866983] &gt;ffff80092f800000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.874251]                    ^  </span><br><span class="line">[   22.877496]  ffff80092f800080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.884766]  ffff80092f800100: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff  </span><br><span class="line">[   22.892034] ==================================================================</span><br></pre></td></tr></table></figure>

<p>对应会告诉我们越界的现场具体位置 bug_function+0x958&#x2F;0xa98 以及具体的越界地址，再结合代码就可以精准定位该问题。</p>
<p>而对于第二种因为设备的直接内存访问导致的内存越界，在我们通过异常的物理地址查看到设备有可能使用该内存的时候，我们就可以进一步去分析相关的代码，这种情况下没有手段去直接定位越界的代码，但可以基于前面的异常现场分析，获取可能的异常来源，比如被踩内存中有类似报文的数据，这种情况下我们可以进一步去分析网卡的 dma 行为。</p>
<h3 id="4-1-延伸"><a href="#4-1-延伸" class="headerlink" title="4.1 延伸"></a>4.1 延伸</h3><p>以上是基于一种出现异常后，分析异常，复现问题，定位问题的思路。我们可以看到其相对比较耗时，如果问题偶现，那即使有 KASAN 这样的手段，也无法长时间复现该类问题。同时 KASAN 虽好，但很难商用，其对单板内存占用的消耗以及内存访问上性能的影响使其只在开发阶段使用。为此开源社区在性能和效率上进行平衡，引入 KFENCE 机制，用于作为系统内存 ues-after-free 和 out-of-bounds 问题的线上手段。</p>
<p>KFENCE 性能消耗小，对系统影响低，可以进行商用部署。其通过采样形式进行检测，虽然存在一定的几率遗漏检测，但一旦检测到相关的越界异常，其产生的效果就是不言而喻的。目前  V7 已经支持 KFENCE，后续如果出现访问越界，便可以基于 KFENCE 的告警信息，进行问题定位。</p>
<p>同时总结内核 oops 异常分析基本步骤，如下：</p>
<ol>
<li><p>获取当前异常对应的内核代码的 vmlinux 以及内核代码，一般 vmlinux 存放在内核编译生成路径的第一级目录下。vmlinux 相当于是具备调试信息的内核镜像，可以基于它分析内核代码的汇编执行流程。</p>
</li>
<li><p>$(toolschain)-objdump -d vmlinux &gt; vmlinux.log，将 vmlinux 反汇编，并重定向到 vmlinux.log 文件中</p>
</li>
<li><p>查看异常现场的指令寄存器 ，比如<code>pc : alloc_vmap_area.isra.6+0x154/0x370</code> ，显示当前指令是在 <code>alloc_vmap_area.isra.6</code>函数偏移 0x154 字节的位置，该函数大小为 0x370 个字节。不同架构的指令寄存器命名稍有区别，对应 x86 为 IP，对于 arm64 为 pc。我们需要结合 vmlinux 和内核代码去确定当前指令具体的执行代码操作。</p>
</li>
<li><p>在 vmlinux.log 中找到异常现场指令寄存器显示的函数，首先需要查看 vmlinux 中函数的大小是否和异常现场显示的函数大小一致，目的是为了确保我们后续对 vmlinux 的解读是和该异常的内核是完全对应的；</p>
</li>
<li><p>找到 vmlinux 中对应偏移的指令地址，查看指令执行的动作，比如操作的寄存器。举例<code>ffff00000821ded4:       f85d0003        ldur    x3, [x0,#-48]</code> ，我们可以看到当前指令地址是 <code>ffff00000821ded4</code>。当前指令是f85d0003，这是指令机器码，对应其汇编代码为 ldur    x3, [x0,#-48] ，表示将访问 x0+(-48) 地址所在内容，并将内容赋值给 x3 寄存器。 利用 addr2line 查看当前指令所在的代码，通过如下命令进行<code>$&#123;toolschain&#125;-addr2line  -e vmlinux -i ffff00000821ded4</code>就可以获取这条指令所在的代码行。这样我们就能从代码逻辑上去进一步分析，当前操作的是哪个变量，执行这个操作的目的是做什么。</p>
<p>不同架构汇编指令存在差异，以下列举常用的几个架构对应指令，方便有不熟悉的指令可以去搜索。</p>
<p>x86：<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel® 64 and IA-32 Architectures Software Developer Manuals</a></p>
<p>arm64：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/linganxiong/p/9119686.html">[转]ARM64 汇编 - 超级大熊 - 博客园</a></p>
<p>ppc：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangliang_571/article/details/40745447">PowerPC汇编指令集_aix unix 汇编命令mfspr_zhangliang_571的博客-CSDN博客</a></p>
<p>mips：<a target="_blank" rel="noopener" href="https://freeflyingsheep.github.io/posts/mips/assembly/">https://freeflyingsheep.github.io/posts/mips/assembly/</a></p>
</li>
<li><p>后续分析就是结合代码和反汇编，反复进行第五步，从异常 PC 位置一步步往前推，结合异常现场输出的各个寄存器内容，来进一步推出最早就存在异常的结构体变量，来判断到底是哪个地方出现了问题，以及后续如果需要调试的话，需要知道什么才可以进一步分析问题。这些就需要具体问题，具体分析。</p>
</li>
</ol>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">哪吒藕霸</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/')">部署ftrace出现内存越界</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=部署ftrace出现内存越界&amp;url=https://shippomx.github.io/2023/05/19/linux/%E9%83%A8%E7%BD%B2%20ftrace%20%E5%87%BA%E7%8E%B0%E5%86%85%E5%AD%98%E8%B6%8A%E7%95%8C%E5%AF%BC%E8%87%B4%E9%9D%9E%E6%B3%95%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%88%86%E6%9E%90/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://shippomx.github.io" target="_blank">远辰</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/linux/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>linux<span class="tagsPageCount">41</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/19/linux/systemtap/systemtap%E8%BF%BD%E8%B8%AA%E8%87%AA%E5%B7%B1%E5%BC%80%E5%8F%91%E7%9A%84%E6%A8%A1%E5%9D%97/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">systemtap 追踪自己开发的模块</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/02/containers/%E4%B8%9A%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%86%85%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E9%80%9F%E7%8E%87%E8%BE%83%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">业务容器内下载文件速率较慢的问题分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2017/06/08/Nginx%20%E9%85%8D%E7%BD%AE%20HTTPS%20%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="Nginx 配置 HTTPS 服务器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2017-06-08</div><div class="title">Nginx 配置 HTTPS 服务器</div></div></a></div><div><a href="/2023/06/21/pty-studio/" title="使用c代码实现伪终端"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-21</div><div class="title">使用c代码实现伪终端</div></div></a></div><div><a href="/2023/06/21/vscode%20cmake/" title="使用vscode调试c代码"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-21</div><div class="title">使用vscode调试c代码</div></div></a></div><div><a href="/2023/06/21/containers/What%20happens%20behind%20the%20scenes%20of%20a%20rootless%20Podman%20container/" title="podman创建rootless容器发生了什么"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-21</div><div class="title">podman创建rootless容器发生了什么</div></div></a></div><div><a href="/2023/06/21/containers/gvisor/" title="gVisor容器引擎"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-21</div><div class="title">gVisor容器引擎</div></div></a></div><div><a href="/2023/03/11/linux/Linux%20%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E8%A7%A3%E6%9E%90%20/" title="进程状态简述"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-03-11</div><div class="title">进程状态简述</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BC%95%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">1.引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">2. 问题背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. 问题分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%8E%B0%E5%9C%BA%E4%B8%80%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 现场一分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%8E%B0%E5%9C%BA%E4%BA%8C%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 现场二分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9F%BA%E4%BA%8E%E7%8E%B0%E5%9C%BA%E5%88%86%E6%9E%90%E7%9A%84%E4%B8%8B%E4%B8%80%E6%AD%A5%E8%B0%83%E8%AF%95%E6%80%9D%E8%B7%AF"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 基于现场分析的下一步调试思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%B7%BB%E5%8A%A0%E8%B0%83%E8%AF%95%E4%BB%A3%E7%A0%81%E5%90%8E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 添加调试代码后复现分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E8%B8%A9%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 踩内存问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E9%85%8D%E7%BD%AE-kasan-%E5%90%8E%E5%88%86%E6%9E%90"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 配置 kasan 后分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 问题解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">4. 经验总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%BB%B6%E4%BC%B8"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 延伸</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/10/%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95/" title="加权轮询算法">加权轮询算法</a><time datetime="2023-12-10T05:29:00.000Z" title="发表于 2023-12-10 13:29:00">2023-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/02/sdn/Using%20ONOS%20as%20a%20robust%20SDN%20controller%20with%20Mininet/" title="using onos as a robust sdn controller with mininet">using onos as a robust sdn controller with mininet</a><time datetime="2023-11-02T03:12:32.000Z" title="发表于 2023-11-02 11:12:32">2023-11-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/10/golang/%E8%B0%88%E8%B0%88%20go.mod%E3%80%81go.sum%E3%80%81go.work/" title="go modules">go modules</a><time datetime="2023-10-10T02:13:22.000Z" title="发表于 2023-10-10 10:13:22">2023-10-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/08/cmake%20starter/" title="cmake starters">cmake starters</a><time datetime="2023-10-08T03:25:56.000Z" title="发表于 2023-10-08 11:25:56">2023-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/07/containers/Docker%E5%AE%B9%E5%99%A8%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%8C%96/" title="Docker与虚拟化">Docker与虚拟化</a><time datetime="2023-10-07T06:44:56.000Z" title="发表于 2023-10-07 14:44:56">2023-10-07</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="哪吒藕霸" target="_blank">哪吒藕霸</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/DPDK/" style="font-size: 0.88rem;">DPDK<sup>3</sup></a><a href="/tags/ONOS/" style="font-size: 0.88rem;">ONOS<sup>1</sup></a><a href="/tags/algorithm/" style="font-size: 0.88rem;">algorithm<sup>1</sup></a><a href="/tags/blockchain/" style="font-size: 0.88rem;">blockchain<sup>1</sup></a><a href="/tags/c/" style="font-size: 0.88rem;">c<sup>1</sup></a><a href="/tags/configuration/" style="font-size: 0.88rem;">configuration<sup>1</sup></a><a href="/tags/container/" style="font-size: 0.88rem;">container<sup>26</sup></a><a href="/tags/go/" style="font-size: 0.88rem;">go<sup>14</sup></a><a href="/tags/kidgets/" style="font-size: 0.88rem;">kidgets<sup>3</sup></a><a href="/tags/linux/" style="font-size: 0.88rem;">linux<sup>41</sup></a><a href="/tags/network/" style="font-size: 0.88rem;">network<sup>9</sup></a><a href="/tags/pppoe/" style="font-size: 0.88rem;">pppoe<sup>1</sup></a><a href="/tags/rust/" style="font-size: 0.88rem;">rust<sup>6</sup></a><a href="/tags/sdn/" style="font-size: 0.88rem;">sdn<sup>4</sup></a><a href="/tags/systemtap/" style="font-size: 0.88rem;">systemtap<sup>4</sup></a><a href="/tags/tools/" style="font-size: 0.88rem;">tools<sup>1</sup></a><a href="/tags/tvbox/" style="font-size: 0.88rem;">tvbox<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 哪吒藕霸 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>