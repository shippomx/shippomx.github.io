<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Kata Containers 2.0 | 远辰</title><meta name="keywords" content="container"><meta name="author" content="哪吒藕霸"><meta name="copyright" content="哪吒藕霸"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Kata Containers 2.0"><meta name="application-name" content="Kata Containers 2.0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Kata Containers 2.0"><meta property="og:url" content="https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/index.html"><meta property="og:site_name" content="远辰"><meta property="og:description" content="Kata Containers 2.0Design内部处理流程 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849┌──────────┐          ┌──────"><meta property="og:locale" content="zh"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="哪吒藕霸"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="Kata Containers 2.0Design内部处理流程 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849┌──────────┐          ┌──────"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 哪吒藕霸","link":"链接: ","source":"来源: 远辰","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '远辰',
  title: 'Kata Containers 2.0',
  postAI: '',
  pageFillDescription: 'Kata Containers 2.0, Design, 概览, 虚拟化, 将容器概念映射到虚拟机技术, Kata Container Hypervisor 和 VMM 支持, gt QEMUx2FKVM, gt Firecrackerx2FKVM, gt Cloud Hypervisorx2FKVM, gt 总结, 虚拟机 Guest assets, Guest kernel, Guest Image, Root filesystem image, Initrd image, Agent, Runtime, 网络 Networking, 存储 Storage, Kubernetes support, Container creation, Container shutdown, Workload exit, Container manager requested shutdown, 附录, DAX, 介绍, 系统要求, 使用 VSOCK 的优点, 高密度, 可靠性, 指标架构, 附图：, How To, 日志, Use Cases, 2.0 里程碑的预设目标, 对 CRI 接口的考虑, 对 CRI Daemon 的影响, 把容器放入沙箱中：效率与隔离性, 关于 Agent 的功能, Sandbox 操作, init 通信守护进程 和 OCI 启动器, Cloud-hypervisor 和 rust-vmm内部处理流程架构概览的交付物是一个友好的在它的后面还有一个友好的库与运行时规范兼容因此可以通过和实现与进行无缝协作为创建的创建虚拟机以下简称为是的入口点它为实现了在之前如在版本中所做的那样我们需要为每个容器和沙箱本身创建一个和以及在不可用时创建一个可选的借助可以启动和兼容的容器每个可以使用一个而不是并且即使没有也不用使用独立的程序然后由生成容器进程是在虚拟机内部作为守护程序运行的代理进程使用串行或接口在虚拟机中运行服务器该接口由生成一个文件暴露给宿主机使用协议与代理进程进行通信该协议允许运行时将容器管理命令发送到代理进程该协议还用于在容器和管理引擎例如或之间承载流对于任何给定的容器该容器中的初始化过程和所有可能执行的命令以及它们相关的流都需要通过导出的接口容器工作负载即实际的已从宿主机导出到虚拟机在配置基于块的图形驱动程序的情况下将使用其他情况下将使用挂载使用此安装点作为容器进程的根文件系统现在默认使用虚拟化虚拟化文档中介绍了如何将容器概念映射到虚拟机技术以及如何在支持的多个虚拟机管理程序和中实现该概念容器是在传统容器提供的隔离之上创建第二层隔离硬件虚拟化接口是此附加层的基础将启动轻型虚拟机并使用虚拟机的内核创建容器工作负载或在多容器的情况下创建工作负载在和实现中是在级别执行的在中此是使用虚拟机创建的将容器概念映射到虚拟机技术容器的典型部署将通过容器运行时接口实现在中进行在每个节点上将与实现器例如或进行交互后者又将与容器基于的运行时交互在存储库中定义的涉及一些由支持的结构体最终在中得到支持为了使用支持完整的必须提供以下结构体然后可以将这些结构体进一步映射到与虚拟机接口所需的设备最终这些概念映射到特定的半虚拟化设备或虚拟化技术每个虚拟机管理程序或在处理每个虚拟机管理程序或如何处理它们方面都各不相同又称虚拟机监控器英语缩写为是用来创建与运行虚拟机的软件固件或硬件被用来运行一个或多个虚拟机的电脑称为宿主机这些虚拟机则称为客户机提供虚拟的作业平台来运行客户操作系统负责管理其他客操作系统的运行阶段这些客操作系统共同分享虚拟化后的硬件资源维基百科和支持旨在支持多个虚拟机监视器和虚拟机管理程序支持具有的容器与完全兼容使用的设备和功能中使用来管理资源限制缩短启动时间并减少内存占用这些记录在下面机器加速器是特定于体系结构的可用于提高性能并启用机器类型的特定功能中使用以下机器加速器此计算机加速器特定于仅和机器类型支持用于将根文件系统作为持久性存储设备提供给虚拟机以最少的资源启动从而缩短了启动时间并减少了内存占用随着容器启动的进行设备会热插拔到例如当指定的约束后要使用更多时可以将其热添加支持热添加以下设备基于其设备模型非常有限占用更小的空间攻击面更小专注于的使用因此带有的支持的子集不支持文件系统共享因此仅支持基于块的存储驱动程序不支持设备热插拔也不支持因此带有的在启动后不支持更新容器资源也不支持设备直通是一套用户态驱动框架可用于编写高效用户态驱动在虚拟化情景下亦可用来在用户态实现通过访问硬件并无新意可贵之处在于第一次向用户态开放了接口能完全在用户态配置将地址空间映射进而限制在进程虚拟地址空间之内这对高性能用户态驱动以及在用户态实现意义重大使用的设备基于的旨在减少占用空间和攻击面对于相对于配置提供了更好的兼容性但以暴露其他设备为代价文件系统共享和直接设备分配从版本开始不支持设备热插拔因此不支持在引导后或使用基于块的卷后更新容器资源尽管确实支持但仍在添加此支持从版本开始不支持基于块的卷或直接设备分配使用的设备总结解决方案引入版本总结上游支持热插拔和文件系统共享不推荐使用从版本开始删除的精简版带有的实验支持上游基于无无共享无内存热插拔支持的上游一旦进入上游将被删除基于包括通过共享和无热插拔虚拟机系统管理程序将启动一个虚拟机该虚拟机包括最小的和被传递到管理程序并用于引导虚拟机中提供的默认内核针对内核启动时间和最小的内存占用进行了高度优化仅提供了容器工作负载所需的那些服务这基于最新的上游内核支持基于和的最小默认的根文件系统映像是基于的高度优化的容器引导系统称为它提供了一个极小的环境并具有高度优化的引导路径在上下文中运行的唯一服务是守护程序和代理使用创建用户希望运行的实际工作负载并以与相同的方式创建容器例如当运行时系统管理程序将使用引导映像在上下文中运行的将在同一上下文中启动代理将创建一个新的受限上下文来运行指定的命令在此示例中为然后代理将在此新上下文中执行命令在此示例中为首先将根文件系统设置为预期的根文件系统从创建的压缩归档文件该归档文件已加载到内存中并用作启动过程的一部分在启动期间内核将其解压缩到的特殊实例中该实例成为初始的根文件系统在上下文中运行的唯一服务是作为守护程序的代理使用创建用户希望运行的实际工作负载并以与相同的方式创建容器是在虚拟机中作为管理员运行的进程用于管理容器和在这些容器中运行的进程对于发行版用编程语言进行了重写以便我们可以最小化其内存占用量同时保持中使用的原始版本的内存安全性这种内存占用空间的减少非常令人印象深刻从几十降至不到这使可以在更多用例例如函数计算和边缘计算中使用执行单元是是由一组和定义的容器可以为每个运行多个容器以支持需要在内运行多个容器的容器引擎通过与其他组件进行通信是运行时的实现负责处理运行时这类似于运行时规范但通过加载一次运行时并通过调用来处理各种容器生命周期管理命令来简化体系结构这种改进是对规范的改进该规范要求容器管理器多次调用运行时二进制文件对于每个生命周期命令至少调用一次大量使用了软件包该软件包提供了通用的运行时规范透明的硬件虚拟化的容器库运行时使用格式的配置文件称为可以通过运行以下命令确定实际的配置文件路径网络存储容器工作负载通过与虚拟化环境共享附录利用内核直接访问文件系统功能将某些主机端文件有效地映射到虚拟机空间特别是使用功能来提供内存映射的虚拟设备该设备可用于将虚拟机的根文件系统映射到来宾内存地址空间与更传统的文件和设备映射机制相比使用映射文件具有许多优点映射为直接访问设备允许虚拟机直接访问主机内存页面例如通过就地执行而忽略虚拟机页面缓存这提供了时间和空间优化通过映射为内部的直接访问设备可以使用页面错误从主机加载页面而不必通过虚拟设备发出请求导致昂贵的退出超调用从而提供了速度优化通过在主机上使用共享内存主机可以有效地共享页面使用以下步骤来设置映射配置了内存设备并带有后端的内存文件以将主机端文件映射到虚拟空间虚拟机内核命令行在启用了功能的情况下挂载此设备从而允许直接页面映射和访问从而绕过了虚拟机页面缓存设计设计要求介绍虚拟机中的进程可以通过两种不同的方式与主机中的进程进行通信第一个是使用串行端口其中虚拟机中的进程可以从串行端口设备读取写入数据而主机中的进程可以从套接字读取写入数据大多数发行版都支持串行端口使其成为最可移植的解决方案但是串行链接一次只能对一个进程进行读写访问一种更新更简单的方法是它可以接受来自多个客户端的连接下图显示了如何在中实现它系统要求主机内核版本必须大于或等于并且模块必须已加载或内置要加载模块请运行以下命令版本必须大于或等于并且必须在运行时配置文件中将设置为使用的优点高密度使用多路传输和主机之间的连接时每个占用在高密度部署中这可能会增加可能用于承载更多的内存当我们谈论密度时每千字节很重要这可能是运行另一个与否之间的决定性因素例如如果服务器中有个则将运行相同数量的进程并消耗约的在决定不使用之前您应该问自己用消耗的内存可以运行多少个容器可靠性如果负责多路复用虚拟机和主机进程之间的连接如果它死掉了那么所有连接就都死掉了例如如果您有一个正在运行个容器的则如果死了尽管它们仍在运行则不可能联系您的容器由于通过进行的通信是直接的因此与容器失去通信的唯一方法是本身或死亡如果发生这种情况则会自动删除容器中虚拟机的大小配置文件中默认为不建议修改如果需要更多的可以通过或来修改创建具有约束的容器时运行时将添加该容器所需的数量同样当容器终止时运行时将删除这些资源没有约束的容器使用配置文件中指定的默认数量对于不受限制的容器使用并在它们之间共享默认数量的在运行不受限制的容器之前请考虑您的容器不是单独运行的由于您的容器在虚拟机中运行因此其他进程也会使用例如和通常建议将设置为以允许非容器进程在此上运行并为每个容器指定约束如果您的容器已经在运行并且需要更多则可以使用添加更多宿主机管理在中工作负载在由主机上运行的虚拟机监视器管理的虚拟机中运行因此在两层上运行第一层在虚拟机中放置工作负载而第二层在主机上运行和关联线程根据上级协调器放置协调器的由协调器管理对于由创建而容器将由运行时处理将根据容器资源要求调整的大小为运行引入了不可忽略的开销基于此可能出现两种情况调整的大小时上层协调器会考虑运行的开销或者没有完全约束和关联的进程而是将它们的子集放置在之外对于如何在主机上处理提供了两个选项通过配置文件中的标志可以选择这些选项详细信息请查阅官方文档指标设计实现的并支持和接口以公开容器指标用户可以使用这些界面来获取有关容器的基本指标但是与不同是基于的运行时并且具有不同的体系结构有许多与可观察性相关的限制可能会限制大规模运行在中以下组件将能够提供有关系统的更多详细信息注意在中面向用户的主要组件是运行时从开始引入了本质上是经过修改的运行时由加载以简化和改进基于的容器的创建和管理方式对于主要组件是尽管已弃用的二进制文件将保留一段时间除非另有明确说明例如明确地将其称为二进制文件否则本文档中对运行时的任何提及均应指代指标架构指标强烈依赖于这是的毕业项目引入了一个名为的新组件该组件用于监视主机上的其他组件这是运行时的监控接口我们可以执行以下操作在本文档中我们将仅涵盖指标直到现在它仅支持指标功能这是中的体系结构概述指标序列图如下所示详细指标介绍请查阅官方文档可以参考这个来收集函数运行内存附图日志可使用记录的日志包括甚至是参考默认情况下日志进入系统日志但也可以配置为存储在文件中日志默认格式为结构化日志记录但可以使用命令行选项将其切换为我们现在使用的是与之前有两个区别日志通过进行定向并将与日志一起捕获例如在标准输出或系统日志中同时将其日志以的系统名称放置在系统日志中可以使用如下命令查看的日志如果需要开启全部组件的使用如下命令参考可选复制配置文件到与一些硬件集成使用的例子可以提升性能里程碑的预设目标的主要目标包括保持和已有的生态系统的兼容性允许将全部的应用内容也就是说不仅是运行时的进程也包括镜像根文件系统封装进沙箱中去掉的不必要功能将宿主机的功能尽量留在用户空间并让长生命周期进程可以使用非权限运行支持并为的场景进行配置与定制那么现在让我们来看看这会对架构和协议接口有什么潜在影响对接口的考虑就而言所有运行时功能都通过容器运行时接口定义位于进行定义仔细看一下我们可以把定义的功能分为两个部分只关于节点本身的全局操作和有上下文的操作节点全局操作相关操作注意里面的是有上下文的操作这个操作从来都是在创建之后才进行的并且从起这个操作就带有一个参数其中的结构是包含名称的所以作为一个高层定义定义得非常谨慎并没有假设镜像的文件系统究竟是维护在沙箱内还是宿主机全局的根据功能的划分我们可以重新分配一下如何实现的功能在也就是目前和的位置应该维护一个节点全局的和容器的索引并且它应该负责根据来通过插件创建沙箱此外的所有内功能的操作应该交给负责相关功能的部分也就是现在的位置不过我想它已经比一个垫片大太多了可能叫沙箱伴侣更合适对的影响要实现上述描述中的镜像进入沙箱的行为需要有一些调整短路掉节点全局功能中的镜像相关动作因为我们把所有的镜像和管理操作都放到沙箱里了所以也就没必要再做全局的镜像管理了对于拉取镜像有两个选择如果我们尽量保持接口的现状的话我们可能需要在里短路拉取镜像的操作等到真的创建容器的时候再去事实地拉取镜像但是上述方法的一个问题是如果拉取镜像出错那么只能表现为创建容器出错这混淆了本身的语义而如果我们想让操作尽可能地忠于他们本身的语义的话我们就应该把这个操作也添加到接口里面对于和操作目前是或者创建标准输入输出并交给执行的但我们如果希望进一步地隔离沙箱就不应该使用宿主机上的管道而应该把标准输入输出的实现的自由交给沙箱当然我们肯定是要支持和的并且要开箱即用毕竟和已经跑在大多数人的机器上了所以上面这些改动应该是可插拔的而且我们在中也应当对当前的和至少保留一个兼容模式把容器放入沙箱中效率与隔离性基于之前文章中的想法我们做了一些把容器镜像拉取工作挪到沙箱里面的调研大致如下图所示我们可以引入一个辅助容器专用来拉取镜像制作容器把这个功能留给一个容器的目的在于我们不希望为此来增加的复杂度并且这样可以尽量少地影响本来的行为与把镜像放在宿主机上相比把镜像放在沙箱中会消耗更多一些的空间而且会影响容器启动的速度因为每次启动都必须拉一次镜像但对于云用户来说这样就不必让镜像被云服务商经手一次了对于云用户和服务商来说常常是可以接受的另一方面在过去的一年里对下一代镜像规范进行了讨论并推出了扩展规范合理利用可以让我们在规范框架内进行一些工作来加速镜像的拉取当然这需要镜像用户授权基础设施来访问用户镜像内容来时下加速这里是我们在阿里巴巴和蚂蚁金服做的镜像加速的一个示意这里利用我们可以把内容感知的元数据也一起放在里在这一端我们可以在下载元数据之后就告知上层镜像拉取已经完成可以启动容器了当接到数据访问请求再延迟拉取镜像这个方案中所有的组件都位于用户空间所以我们可以加入很多高级功能比如更好的数据去重和的数据校验不需要全部拉取就可以进行数据完整性检查这些逻辑对和应该是通用的关于的功能接下来是内部危险区我们对对考量包括对于长时间运行对应该仅仅包含必须要做的功能能做的越少我们也就越安全但是要保证和镜像与语义的兼容性当然也要尽量低开销在版本的开发周期中我们已经试验性地加入了一个版本的它的体积要远小于之前的版本而且我们也实现了一个版本的并正在测试中本文发出时已经开源并贡献回到的上游社区了把这些都集中在一起我们有望将的内存开销压向下面我们就来看看部分计划中的的架构操作在上海上的功能也是讨论的焦点之一部分开发者提起中的操作对是否有意义因为正在运行本身就意味着已经建立好了所以一个想法是要从协议中去掉和两个操作不过在语境里本身实际上是执行的操作这个语义仍然是需要的不过我们可能确实可以去掉来简化的容器组织通信守护进程和启动器另一方面我们也在考察的内在功能在上海峰会的论坛讨论中与会者都同意是被攻击风险最高的组件显然应该让它的守护进程的权限越少越好这里我们可以把的功能划分成这么几个部分容器的显然是需要的无法删除在内解析运行容器的功能可以在容器创建之后退出监控事件等关于可观测性可调试性的功能肯定是需要的但我们应该努力让它们更加安全高效简而言之本身的发展方向应该是不仅更轻而且更加模块化并被更仔细地限制访问权限和在开发周期里做的另一个工作是把作为的一个新的在里我们希望可以进一步推进这个方向我在上一篇里提到让主机的用户态工具乃至应用的内核联合起来彼此协同为沙箱中的应用提供服务因为目前的是一个中立模块化和比较安全的我们可以考虑构建一个的添加我们需要的功能减除不必要的功能来作为我们的面向云原生的虚拟化的一个部分',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-28 16:22:11',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">远辰</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/algorithm/" style="font-size: 1.05rem;">algorithm<sup>1</sup></a><a href="/tags/blockchain/" style="font-size: 1.05rem;">blockchain<sup>1</sup></a><a href="/tags/c/" style="font-size: 1.05rem;">c<sup>1</sup></a><a href="/tags/container/" style="font-size: 1.05rem;">container<sup>27</sup></a><a href="/tags/go/" style="font-size: 1.05rem;">go<sup>10</sup></a><a href="/tags/kidgets/" style="font-size: 1.05rem;">kidgets<sup>3</sup></a><a href="/tags/linux/" style="font-size: 1.05rem;">linux<sup>22</sup></a><a href="/tags/rust/" style="font-size: 1.05rem;">rust<sup>6</sup></a><a href="/tags/tools/" style="font-size: 1.05rem;">tools<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">October 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">September 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">July 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">June 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">May 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">April 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">March 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/02/"><span class="card-archive-list-date">February 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"><a class="article-meta__tags" href="/tags/container/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>container</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Kata Containers 2.0</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2020-12-20T02:23:30.000Z" title="发表于 2020-12-20 10:23:30">2020-12-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-09-28T08:22:11.039Z" title="更新于 2023-09-28 16:22:11">2023-09-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/"><header><a href="/tags/container/" tabindex="-1" itemprop="url">container</a><h1 id="CrawlerTitle" itemprop="name headline">Kata Containers 2.0</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">哪吒藕霸</span><time itemprop="dateCreated datePublished" datetime="2020-12-20T02:23:30.000Z" title="发表于 2020-12-20 10:23:30">2020-12-20</time><time itemprop="dateCreated datePublished" datetime="2023-09-28T08:22:11.039Z" title="更新于 2023-09-28 16:22:11">2023-09-28</time></header><h1 id="Kata-Containers-2-0"><a href="#Kata-Containers-2-0" class="headerlink" title="Kata Containers 2.0"></a>Kata Containers 2.0</h1><h1 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h1><p>内部处理流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌──────────┐          ┌───────┐           ┌──────────────┐          ┌──────────┐          ┌─────┐                                      </span><br><span class="line">│docker/k8s│          │runtime│           │virtcontainers│          │hypervisor│          │agent│                                      </span><br><span class="line">└────┬─────┘          └───┬───┘           └──────┬───────┘          └────┬─────┘          └──┬──┘                                      </span><br><span class="line">     │       create       │                      │                       │                   │                                         </span><br><span class="line">     │ ──────────────────&gt;│                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │   CreateSandbox()    │                       │                   │                                         </span><br><span class="line">     │                    │──────────────────────&gt;                       │                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │        Start VM       │                   │                                         </span><br><span class="line">     │                    │                      │ ──────────────────────&gt;                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │       VM started      │                   │                                         </span><br><span class="line">     │                    │                      │ &lt;─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                    │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │              CreateSandbox()              │                                         </span><br><span class="line">     │                    │                      │ ─────────────────────────────────────────&gt;│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │              Sandbox Created              │                                         </span><br><span class="line">     │                    │                      │ &lt;─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │────┐                  │                   │                                         </span><br><span class="line">     │                    │                      │    │ s.getAnnotations │                   │                                         </span><br><span class="line">     │                    │                      │&lt;───┘                  │                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │       s.agent.UpdateHugePageRequest       │                                         </span><br><span class="line">     │                    │                      │ ─────────────────────────────────────────&gt;│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │────┐                                    </span><br><span class="line">     │                    │                      │                       │                   │    │ echo xx &gt; /proc/sys/vm/nr_hugepages</span><br><span class="line">     │                    │                      │                       │                   │&lt;───┘                                    </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │       End of UpdateHugePageRequest        │                                         </span><br><span class="line">     │                    │                      │ &lt;─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │             CreateContainer()             │                                         </span><br><span class="line">     │                    │                      │ ─────────────────────────────────────────&gt;│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │                      │             Container Created             │                                         </span><br><span class="line">     │                    │                      │ &lt;─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │                    │End of CreateSandbox()│                       │                   │                                         </span><br><span class="line">     │                    │&lt;─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─                        │                   │                                         </span><br><span class="line">     │                    │                      │                       │                   │                                         </span><br><span class="line">     │   End of create    │                      │                       │                   │                                         </span><br><span class="line">     │ &lt;─ ─ ─ ─ ─ ─ ─ ─ ─ │                      │                       │                   │                                         </span><br><span class="line">┌────┴─────┐          ┌───┴───┐           ┌──────┴───────┐          ┌────┴─────┐          ┌──┴──┐                                      </span><br><span class="line">│docker/k8s│          │runtime│           │virtcontainers│          │hypervisor│          │agent│                                      </span><br><span class="line">└──────────┘          └───────┘           └──────────────┘          └──────────┘          └─────┘</span><br></pre></td></tr></table></figure>

<ol>
<li>Kata Containers 架构</li>
</ol>
<hr>
<h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>Kata Containers 的交付物是一个 CRI 友好的 Shim（e.g. containerd-shim-kata-v2），在它的后面还有一个 CRI 友好的 API 库。  </p>
<p>Kata Containers runtime 与 OCI 运行时规范兼容，因此，可以通过 CRI-O 和 Containerd 实现与 Kubernetes CRI 进行无缝协作。  </p>
<p>Kata Containers 为 kubelet 创建的 Pod 创建 QEMU&#x2F;KVM 虚拟机。  </p>
<p><strong>containerd-shim-kata-v2</strong>（以下简称为 shimv2） 是 Kata Containers 的入口点，它为 Kata 实现了 Containered Runtime V2（Shim API）。  </p>
<p>在 shimv2 之前（如在 Kata Containers 1.x 版本中所做的那样），我们需要为每个容器和 Pod 沙箱本身创建一个 containerd-shim 和 kata-shim，以及在 VSOCK 不可用时创建一个可选的 kata-proxy。借助 shimv2，Kubernetes 可以启动 Pod 和 OCI 兼容的容器，每个 Pod 可以使用一个 Shim（shimv2）而不是 2N+1 Shim，并且即使没有 VSOCK 也不用使用独立的 kata-proxy 程序。  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/a5abc05c6bd5dd5b28e4e660d260a08c.png">  </p>
<p>然后，由 kata-agent 生成容器进程，kata-agent 是在虚拟机内部作为守护程序运行的代理进程。kata-agent 使用 VIRTIO 串行或 VSOCK 接口在虚拟机中运行 ttRPC 服务器，该接口由 QEMU 生成一个 Socket 文件暴露给宿主机。shimv2 使用 ttRPC 协议与代理进程进行通信。该协议允许运行时将容器管理命令发送到代理进程。该协议还用于在容器和管理引擎（例如 CRI-O 或 Containerd）之间承载 I&#x2F;O 流（stdout，stderr，stdin）。  </p>
<p>对于任何给定的容器，该容器中的初始化过程和所有可能执行的命令以及它们相关的 I&#x2F;O 流都需要通过 QEMU 导出的 VSOCK 接口。  </p>
<p>容器工作负载（即实际的 OCI bundle rootfs）已从宿主机导出到虚拟机。在配置基于块的图形驱动程序的情况下，将使用 virtio-scsi。其他情况下，将使用 9pfs VIRTIO 挂载。kata-agent 使用此安装点作为容器进程的根文件系统。（现在默认使用 virtis-fs）  </p>
<h3 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a>虚拟化</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/virtualization.md">虚拟化文档</a>中介绍了 Kata Containers 如何将容器概念映射到虚拟机技术，以及如何在 Kata 支持的多个虚拟机管理程序和 VMM 中实现该概念。  </p>
<p>Kata 容器是在传统 namespace 容器提供的隔离之上创建第二层隔离。硬件虚拟化接口是此附加层的基础。Kata 将启动轻型虚拟机，并使用虚拟机的 Linux 内核创建容器工作负载，或在多容器 Pod 的情况下创建工作负载。 在 Kubernetes 和 Kata 实现中，Sandbox 是在 Pod 级别执行的。在 Kata 中，此 Sandbox 是使用虚拟机创建的。  </p>
<h4 id="将容器概念映射到虚拟机技术"><a href="#将容器概念映射到虚拟机技术" class="headerlink" title="将容器概念映射到虚拟机技术"></a>将容器概念映射到虚拟机技术</h4><p>Kata 容器的典型部署将通过容器运行时接口（CRI）实现在 Kubernetes 中进行。在每个节点上，Kubelet 将与 CRI 实现器（例如 Containerd 或 CRI-O）进行交互，后者又将与 Kata 容器（基于 OCI 的运行时）交互。  </p>
<p>在 Kubernetes CRI-API 存储库中定义的 CRI API 涉及一些由 CRI 支持的结构体，最终在 Kata Containers 中得到支持。为了使用 CRI-implementor 支持完整的 API，Kata 必须提供以下结构体：  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/dbe558964cd872764bb4d229eafe357c.png">  </p>
<p>然后可以将这些结构体进一步映射到与虚拟机接口所需的设备：  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/d7ce604c521fca153bcb312c9c737689.png">  </p>
<p>最终，这些概念映射到特定的半虚拟化设备或虚拟化技术。  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/148fd36cab3bda6daa0965047b72918b.png">  </p>
<p>每个虚拟机管理程序或 VMM 在处理每个虚拟机管理程序或如何处理它们方面都各不相同。  </p>
<blockquote>
<p><strong>Hypervisor</strong>，又称<strong>虚拟机监控器</strong>（英语：virtual machine monitor，缩写为 VMM），是用来创建与运行虚拟机的软件、固件或硬件。<br>被 hypervisor 用来运行一个或多个虚拟机的电脑称为宿主机（host machine），这些虚拟机则称为客户机（guest machine）。Hypervisor 提供虚拟的作业平台来运行客户操作系统（guest operating systems），负责管理其他客操作系统的运行阶段；这些客操作系统，共同分享虚拟化后的硬件资源.</p>
<p>​																																																								—— <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Hypervisor">维基百科</a></p>
</blockquote>
<h4 id="Kata-Container-Hypervisor-和-VMM-支持"><a href="#Kata-Container-Hypervisor-和-VMM-支持" class="headerlink" title="Kata Container Hypervisor 和 VMM 支持"></a>Kata Container Hypervisor 和 VMM 支持</h4><p>Kata Containers 旨在支持多个虚拟机监视器（VMM）和虚拟机管理程序。Kata Containers 支持：</p>
<ul>
<li>ACRN hypervisor</li>
<li>Cloud Hypervisor&#x2F;KVM</li>
<li>Firecracker&#x2F;KVM</li>
<li>QEMU&#x2F;KVM</li>
</ul>
<h5 id="gt-QEMU-x2F-KVM"><a href="#gt-QEMU-x2F-KVM" class="headerlink" title="&gt; QEMU&#x2F;KVM"></a>&gt; QEMU&#x2F;KVM</h5><p>具有 QEMU 的 Kata 容器与 Kubernetes 完全兼容。  </p>
<p>使用的设备和功能：</p>
<ul>
<li>virtio VSOCK or virtio serial</li>
<li>virtio block or virtio SCSI</li>
<li>virtio net</li>
<li>virtio fs or virtio 9p (recommend: virtio fs)</li>
<li>VFIO</li>
<li>hotplug</li>
<li>machine accelerators</li>
</ul>
<p>Kata Containers 中使用 machine accelerators and hotplug 来管理资源限制，缩短启动时间并减少内存占用。 这些记录在下面。  </p>
<p><strong>Machine accelerators：</strong> 机器加速器是特定于体系结构的，可用于提高性能并启用机器类型的特定功能。Kata Containers 中使用以下机器加速器：</p>
<ul>
<li>NVDIMM：此计算机加速器特定于 x86，仅 pc 和 q35 机器类型支持。nvdimm 用于将根文件系统作为持久性存储设备提供给虚拟机。</li>
</ul>
<p><strong>Hotplug devices：</strong> Kata Containers VM 以最少的资源启动，从而缩短了启动时间并减少了内存占用。随着容器启动的进行，设备会热插拔到 VM。例如，当指定的 CPU 约束后要使用更多 CPU 时，可以将其热添加。Kata Containers 支持热添加以下设备：</p>
<ul>
<li>Virtio block</li>
<li>Virtio SCSI</li>
<li>VFIO</li>
<li>CPU</li>
</ul>
<h5 id="gt-Firecracker-x2F-KVM"><a href="#gt-Firecracker-x2F-KVM" class="headerlink" title="&gt; Firecracker&#x2F;KVM"></a>&gt; Firecracker&#x2F;KVM</h5><p>Firecracker 基于 rust-VMM，其设备模型非常有限，占用更小的空间，攻击面更小，专注于 FaaS 的使用。因此，带有 Firecracker VMM 的 Kata Containers 支持 CRI API 的子集。Firecracker 不支持文件系统共享，因此仅支持基于块的存储驱动程序。Firecracker 不支持设备热插拔，也不支持 VFIO。因此，带有 Firecracker VMM 的 Kata Containers 在启动后不支持更新容器资源，也不支持设备直通。  </p>
<blockquote>
<p>VFIO 是一套用户态驱动框架，可用于编写高效用户态驱动；在虚拟化情景下，亦可用来在用户态实现 device passthrough。通过 VFIO 访问硬件并无新意，VFIO 可贵之处在于第一次向用户态开放了 IOMMU 接口，能完全在用户态配置 IOMMU，将 DMA 地址空间映射进而限制在进程虚拟地址空间之内。这对高性能用户态驱动以及在用户态实现 device passthrough 意义重大。</p>
</blockquote>
<blockquote>
<p>—— <a target="_blank" rel="noopener" href="https://blog.csdn.net/nb_zsy/article/details/106602334">https://blog.csdn.net/nb_zsy&#x2F;article&#x2F;details&#x2F;106602334</a></p>
</blockquote>
<p>使用的设备：</p>
<ul>
<li>virtio VSOCK</li>
<li>virtio block</li>
<li>virtio net</li>
</ul>
<h5 id="gt-Cloud-Hypervisor-x2F-KVM"><a href="#gt-Cloud-Hypervisor-x2F-KVM" class="headerlink" title="&gt; Cloud Hypervisor&#x2F;KVM"></a>&gt; Cloud Hypervisor&#x2F;KVM</h5><p>基于 rust-VMM 的 Cloud Hypervisor 旨在减少占用空间和攻击面。对于 Kata Containers，相对于 Firecracker，Cloud Hypervisor 配置提供了更好的兼容性，但以暴露其他设备为代价：文件系统共享和直接设备分配。从 Kata Containers 1.10 版本开始，Cloud Hypervisor 不支持设备热插拔，因此不支持在引导后或使用基于块的卷后更新容器资源。尽管 Cloud Hypervisor 确实支持 VFIO，但 Kata 仍在添加此支持。从 1.10 版本开始，Kata 不支持基于块的卷或直接设备分配。  </p>
<p>使用的设备：</p>
<ul>
<li>virtio VSOCK</li>
<li>virtio block</li>
<li>virtio net</li>
<li>virtio fs</li>
</ul>
<h5 id="gt-总结"><a href="#gt-总结" class="headerlink" title="&gt; 总结"></a>&gt; 总结</h5><table><thead><tr><th>解决方案</th><th>引入版本</th><th>总结</th></tr></thead><tbody><tr><td>QEMU</td><td>1.0</td><td>上游 QEMU，支持热插拔和文件系统共享</td></tr><tr><td>NEMU</td><td>1.4</td><td>不推荐使用，从 1.10 版本开始删除。 QEMU 的精简版，带有 virtio-fs 的实验支持</td></tr><tr><td>Firecracker</td><td>1.5</td><td>上游 Firecracker，基于 rust-VMM，无 VFIO，无 FS 共享，无内存 / CPU 热插拔</td></tr><tr><td>QEMU-virtio-fs</td><td>1.7</td><td>支持 virtio-fs 的上游 QEMU。一旦 virtio-fs 进入上游 QEMU，将被删除</td></tr><tr><td>Cloud Hypervisor</td><td>1.10</td><td>基于 rust-VMM，包括通过 virtio-fs 共享 VFIO 和 FS，无热插拔</td></tr></tbody></table>

<h3 id="虚拟机-Guest-assets"><a href="#虚拟机-Guest-assets" class="headerlink" title="虚拟机 Guest assets"></a>虚拟机 Guest assets</h3><p>系统管理程序将启动一个虚拟机，该虚拟机包括最小的 guest kernel 和 guest image。  </p>
<h4 id="Guest-kernel"><a href="#Guest-kernel" class="headerlink" title="Guest kernel"></a>Guest kernel</h4><p>guest kernel 被传递到管理程序，并用于引导虚拟机。Kata Containers 中提供的默认内核针对内核启动时间和最小的内存占用进行了高度优化，仅提供了容器工作负载所需的那些服务。这基于最新的上游 Linux 内核。  </p>
<h4 id="Guest-Image"><a href="#Guest-Image" class="headerlink" title="Guest Image"></a>Guest Image</h4><p>Kata Containers 支持基于 initrd 和 rootfs 的最小 guest image。  </p>
<h5 id="Root-filesystem-image"><a href="#Root-filesystem-image" class="headerlink" title="Root filesystem image"></a>Root filesystem image</h5><p>默认的根文件系统映像是基于 Clear Linux 的高度优化的容器引导系统，称为 “mini O&#x2F;S”。它提供了一个极小的环境，并具有高度优化的引导路径。  </p>
<p>在 mini O&#x2F;S 上下文中运行的唯一服务是 init 守护程序（systemd）和代理 Agent。 使用 libcontainer 创建用户希望运行的实际工作负载，并以与 runc 相同的方式创建容器。  </p>
<p>例如，当运行 ctr run -ti ubuntu date 时：</p>
<ul>
<li>系统管理程序将使用 guest kernel 引导 mini-OS 映像。</li>
<li>在 mini-OS 上下文中运行的 systemd 将在同一上下文中启动 kata-agent。</li>
<li>代理将创建一个新的受限上下文来运行指定的命令（在此示例中为 date）。</li>
<li>然后，代理将在此新上下文中执行命令（在此示例中为 date），首先将根文件系统设置为预期的 Ubuntu 根文件系统。</li>
</ul>
<h5 id="Initrd-image"><a href="#Initrd-image" class="headerlink" title="Initrd image"></a>Initrd image</h5><p>从 rootfs 创建的压缩 cpio(1) 归档文件，该归档文件已加载到内存中，并用作 Linux 启动过程的一部分。在启动期间，内核将其解压缩到 tmpfs 的特殊实例中，该实例成为初始的根文件系统。  </p>
<p>在 initrd 上下文中运行的唯一服务是作为 init 守护程序的代理 Agent。 使用 libcontainer 创建用户希望运行的实际工作负载，并以与 runc 相同的方式创建容器。  </p>
<h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><p>kata-agent 是在虚拟机中作为管理员运行的进程，用于管理容器和在这些容器中运行的进程。  </p>
<p>对于 2.0 发行版，kata-agent 用 Rust 编程语言进行了重写，以便我们可以最小化其内存占用量，同时保持 Kata Container 1.x 中使用的 kata-agent 原始 Go 版本的内存安全性。这种内存占用空间的减少非常令人印象深刻，从几十 MB 降至不到 100 KB，这使 Kata Containers 可以在更多用例（例如函数计算和边缘计算）中使用。  </p>
<p>kata-agent 执行单元是 Sandbox。kata-agent Sandbox 是由一组 namespace（NS，UTS，IPC 和 PID）定义的容器 Sandbox。 shimv2 可以为每个 VM 运行多个容器，以支持需要在 Pod 内运行多个容器的容器引擎。  </p>
<p>kata-agent 通过 ttRPC 与其他 Kata 组件进行通信。  </p>
<h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><p>containerd-shim-kata-v2 是 Containerd 运行时 shimv2 的实现，负责处理运行时 v2 shim API，这类似于 OCI 运行时规范，但通过加载一次运行时并通过 RPC 调用来处理各种容器生命周期管理命令来简化体系结构。这种改进是对 OCI 规范的改进，该规范要求容器管理器多次调用运行时二进制文件，对于每个生命周期命令至少调用一次。  </p>
<p>containerd-shim-kata-v2 大量使用了 virtcontainers 软件包，该软件包提供了通用的，运行时规范透明的，硬件虚拟化的容器库。  </p>
<p>运行时使用 TOML 格式的配置文件，称为 configuration.toml。可以通过运行以下命令确定实际的配置文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kata-runtime --kata-show-default-config-paths</span><br></pre></td></tr></table></figure>

<h3 id="网络-Networking"><a href="#网络-Networking" class="headerlink" title="网络 Networking"></a>网络 Networking</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#networking">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#networking</a>  </p>
<h3 id="存储-Storage"><a href="#存储-Storage" class="headerlink" title="存储 Storage"></a>存储 Storage</h3><p>容器工作负载通过 virtio-fs 与虚拟化环境共享。  </p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#storage">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#storage</a>  </p>
<h3 id="Kubernetes-support"><a href="#Kubernetes-support" class="headerlink" title="Kubernetes support"></a>Kubernetes support</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#kubernetes-support">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/architecture.md#kubernetes-support</a>  </p>
<h3 id="Container-creation"><a href="#Container-creation" class="headerlink" title="Container creation"></a>Container creation</h3><p>The steps below show at a high level how a Kata Containers container is<br>created using the containerd container manager:</p>
<ol>
<li><p>The user requests the creation of a container by running a command<br>like the <a href="example-command.md">example command</a>.</p>
</li>
<li><p>The container manager daemon runs a single instance of the Kata<br><a href="#runtime">runtime</a>.</p>
</li>
<li><p>The Kata runtime loads its <a href="#configuration">configuration file</a>.</p>
</li>
<li><p>The container manager calls a set of shimv2 API functions on the runtime.</p>
</li>
<li><p>The Kata runtime launches the configured <a href="#hypervisor">hypervisor</a>.</p>
</li>
<li><p>The hypervisor creates and starts (<em>boots</em>) a VM using the<br><a href="guest-assets.md#guest-assets">guest assets</a>:</p>
<ul>
<li><p>The hypervisor <a href="#dax">DAX</a> shares the<br><a href="guest-assets.md#guest-image">guest image</a><br>into the VM to become the VM <a href="background.md#root-filesystem">rootfs</a> (mounted on a <code>/dev/pmem*</code> device),<br>which is known as the <a href="#environments">VM root environment</a>.</p>
</li>
<li><p>The hypervisor mounts the <a href="background.md#oci-bundle">OCI bundle</a>, using <a href="storage.md#virtio-fs">virtio FS</a>,<br>into a container specific directory inside the VM’s rootfs.</p>
<p>This container specific directory will become the<br><a href="#environments">container rootfs</a>, known as the<br><a href="#environments">container environment</a>.</p>
</li>
</ul>
</li>
<li><p>The <a href="#agent">agent</a> is started as part of the VM boot.</p>
</li>
<li><p>The runtime calls the agent’s <code>CreateSandbox</code> API to request the<br>agent create a container:</p>
<ol>
<li><p>The agent creates a <a href="#environments">container environment</a><br>in the container specific directory that contains the <a href="#environments">container rootfs</a>.</p>
<p>The container environment hosts the <a href="#workload">workload</a> in the<br><a href="#environments">container rootfs</a> directory.</p>
</li>
<li><p>The agent spawns the workload inside the container environment.</p>
</li>
</ol>
<blockquote>
<p><strong>Notes:</strong></p>
<ul>
<li><p>The container environment created by the agent is equivalent to<br>a container environment created by the<br><a target="_blank" rel="noopener" href="https://github.com/opencontainers/runc"><code>runc</code></a> OCI runtime;<br>Linux cgroups and namespaces are created inside the VM by the<br><a href="guest-assets.md#guest-kernel">guest kernel</a> to isolate the<br>workload from the VM environment the container is created in.<br>See the <a href="#environments">Environments</a> section for an<br>explanation of why this is done.</p>
</li>
<li><p>See the <a href="guest-assets.md#guest-image">guest image</a> section for<br>details of exactly how the agent is started.</p>
</li>
</ul>
</blockquote>
</li>
<li><p>The container manager returns control of the container to the<br>user running the <code>ctr</code> command.</p>
</li>
</ol>
<blockquote>
<p><strong>Note:</strong></p>
<p>At this point, the container is running and:</p>
<ul>
<li>The <a href="#workload">workload</a> process (<a href="example-command.md"><code>sh(1)</code> in the example</a>)<br>is running in the <a href="#environments">container environment</a>.</li>
<li>The user is now able to interact with the workload<br>(using the <a href="example-command.md"><code>ctr</code> command in the example</a>).</li>
<li>The <a href="#agent">agent</a>, running inside the VM is monitoring the<br><a href="#workload">workload</a> process.</li>
<li>The <a href="#runtime">runtime</a> is waiting for the agent’s <code>WaitProcess</code> API<br>call to complete.</li>
</ul>
</blockquote>
<p>Further details of these steps are provided in the sections below.</p>
<h3 id="Container-shutdown"><a href="#Container-shutdown" class="headerlink" title="Container shutdown"></a>Container shutdown</h3><p>There are two possible ways for the container environment to be<br>terminated:</p>
<ul>
<li><p>When the <a href="#workload">workload</a> exits.</p>
<p>This is the standard, or <em>graceful</em> shutdown method.</p>
</li>
<li><p>When the container manager forces the container to be deleted.</p>
</li>
</ul>
<h4 id="Workload-exit"><a href="#Workload-exit" class="headerlink" title="Workload exit"></a>Workload exit</h4><p>The <a href="#agent">agent</a> will detect when the <a href="#workload">workload</a> process<br>exits, capture its exit status (see <code>wait(2)</code>) and return that value<br>to the <a href="#runtime">runtime</a> by specifying it as the response to the<br><code>WaitProcess</code> agent API call made by the <a href="#runtime">runtime</a>.</p>
<p>The runtime then passes the value back to the container manager by the<br><code>Wait</code> <a href="#shim-v2-architecture">shimv2 API</a> call.</p>
<p>Once the workload has fully exited, the VM is no longer needed and the<br>runtime cleans up the environment (which includes terminating the<br><a href="#hypervisor">hypervisor</a> process).</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>When <a href="../../tracing.md#agent-shutdown-behaviour">agent tracing is enabled</a>,<br>the shutdown behaviour is different.</p>
</blockquote>
<h4 id="Container-manager-requested-shutdown"><a href="#Container-manager-requested-shutdown" class="headerlink" title="Container manager requested shutdown"></a>Container manager requested shutdown</h4><p>If the container manager requests the container be deleted, the<br><a href="#runtime">runtime</a> will signal the agent by sending it a<br><code>DestroySandbox</code> <a href="../../../src/libs/protocols/protos/agent.proto">ttRPC API</a> request.</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><h4 id="DAX"><a href="#DAX" class="headerlink" title="DAX"></a>DAX</h4><p>Kata Containers 利用 Linux 内核 DAX（直接访问文件系统）功能将某些主机端文件有效地映射到虚拟机 VM 空间。<strong>特别是，Kata Containers 使用 QEMU NVDIMM 功能来提供内存映射的虚拟设备，该设备可用于 DAX 将虚拟机的根文件系统映射到来宾内存地址空间。</strong>  </p>
<p>与更传统的 VM 文件和设备映射机制相比，使用 DAX 映射文件具有许多优点：  </p>
<ul>
<li>映射为直接访问设备允许虚拟机直接访问主机内存页面（例如通过就地执行（XIP）），而忽略虚拟机页面缓存。这提供了时间和空间优化。</li>
<li>通过映射为 VM 内部的直接访问设备，可以使用页面错误从主机加载页面，而不必通过虚拟设备发出请求（导致昂贵的 VM 退出 &#x2F; 超调用），从而提供了速度优化。</li>
<li>通过在主机上使用 MAP_SHARED 共享内存，主机可以有效地共享页面。</li>
</ul>
<p>Kata Containers 使用以下步骤来设置 DAX 映射：  </p>
<ol>
<li>QEMU 配置了 NVDIMM 内存设备，并带有后端的内存文件以将主机端文件映射到虚拟 NVDIMM 空间。</li>
<li>虚拟机内核命令行在启用了 DAX 功能的情况下挂载此 NVDIMM 设备，从而允许直接页面映射和访问，从而绕过了虚拟机页面缓存。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/6ab939fb34c0c177c97ea3fd958b2b9a.png">  </p>
<ol start="2">
<li>Kata API 设计</li>
</ol>
<hr>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-api-design.md">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-api-design.md</a>  </p>
<ol start="3">
<li>设计要求</li>
</ol>
<hr>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-design-requirements.md">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-design-requirements.md</a>  </p>
<ol start="4">
<li>Kata Containers and VSOCKs</li>
</ol>
<hr>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>虚拟机中的进程可以通过两种不同的方式与主机中的进程进行通信。第一个是使用串行端口，其中虚拟机中的进程可以从串行端口设备读取 &#x2F; 写入数据，而主机中的进程可以从 Unix 套接字读取 &#x2F; 写入数据。大多数 GNU&#x2F;Linux 发行版都支持串行端口，使其成为最可移植的解决方案。但是，串行链接一次只能对一个进程进行读 &#x2F; 写访问。  </p>
<p>一种更新，更简单的方法是 VSOCK，它可以接受来自多个客户端的连接。下图显示了如何在 Kata Containers 中实现它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.----------------------.</span><br><span class="line">| .------------------. |</span><br><span class="line">| | .-----.  .-----. | |</span><br><span class="line">| | |cont1|  |cont2| | |</span><br><span class="line">| | `-----&#x27;  `-----&#x27; | |</span><br><span class="line">| |       |   |      | |</span><br><span class="line">| |    .---------.   | |</span><br><span class="line">| |    |  agent  |   | |</span><br><span class="line">| |    `---------&#x27;   | |</span><br><span class="line">| |       |   |      | |</span><br><span class="line">| | POD .-------.    | |</span><br><span class="line">| `-----| vsock |----&#x27; |</span><br><span class="line">|       `-------&#x27;      |</span><br><span class="line">|         |   |        |</span><br><span class="line">|  .------.   .------. |</span><br><span class="line">|  | shim |   | shim | |</span><br><span class="line">|  `------&#x27;   `------&#x27; |</span><br><span class="line">| Host                 |</span><br><span class="line">`----------------------&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h3><p>主机 Linux 内核版本必须大于或等于 v4.8，并且 vhost_vsock 模块必须已加载或内置（CONFIG_VHOST_VSOCK &#x3D; y）。要加载模块，请运行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo modprobe -i vhost_vsock</span><br></pre></td></tr></table></figure>


<p>Kata Containers 版本必须大于或等于 1.2.0，并且必须在运行时配置文件中将 use_vsock 设置为 true。  </p>
<h3 id="使用-VSOCK-的优点"><a href="#使用-VSOCK-的优点" class="headerlink" title="使用 VSOCK 的优点"></a>使用 VSOCK 的优点</h3><h4 id="高密度"><a href="#高密度" class="headerlink" title="高密度"></a>高密度</h4><p>使用 Proxy 多路传输 VM 和主机之间的连接时，每个 Pod 占用 4.5MB。在高密度部署中，这可能会增加可能用于承载更多 Pod 的 GB 内存。当我们谈论密度时，每千字节很重要，这可能是运行另一个 Pod 与否之间的决定性因素。例如，如果服务器中有 500 个 Pod，则将运行相同数量的 kata-proxy 进程，并消耗约 2250MB 的 RAM。 在决定不使用 VSOCK 之前，您应该问自己，用 Kata Proxy 消耗的内存 RAM 可以运行多少个容器？  </p>
<h4 id="可靠性"><a href="#可靠性" class="headerlink" title="可靠性"></a>可靠性</h4><p>如果 kata-proxy 负责多路复用虚拟机和主机进程之间的连接，如果它死掉了，那么所有连接就都死掉了。例如，如果您有一个正在运行 10 个容器的 Pod，则如果 kata-proxy 死了，尽管它们仍在运行，则不可能联系您的容器。 由于通过 VSOCK 进行的通信是直接的，因此与容器失去通信的唯一方法是 VM 本身或 containerd-shim-kata-v2 死亡，如果发生这种情况，则会自动删除容器。  </p>
<ol start="5">
<li>Kata Containers 中虚拟机的 vCPU 大小</li>
</ol>
<hr>
<p><strong>配置文件中 default_vcpus 默认为 1，不建议修改。如果需要更多的 CPU，可以通过 docker –cpus, docker update 或 Kubernetes cpu limits 来修改。</strong></p>
<p>创建具有 CPU 约束的容器时，运行时将添加该容器所需的 vCPU 数量。 同样，当容器终止时，运行时将删除这些资源。  </p>
<p>没有 CPU 约束的容器使用配置文件中指定的默认 vCPU 数量。对于 Kubernetes Pod，不受 CPU 限制的容器使用并在它们之间共享默认数量的 vCPU。  </p>
<p>在运行不受 CPU 限制的容器之前，请考虑您的容器不是单独运行的。 由于您的容器在虚拟机中运行，因此其他进程也会使用 vCPU（例如 systemd 和 Kata Containers Agent）。 通常，建议将 default_vcpus 设置为 1，以允许非容器进程在此 vCPU 上运行，并为每个容器指定 CPU 约束。 如果您的容器已经在运行并且需要更多 vCPU，则可以使用 docker update 添加更多。  </p>
<ol start="6">
<li>宿主机 cgroup 管理</li>
</ol>
<hr>
<p>在 Kata Containers 中，工作负载在由主机上运行的虚拟机监视器（VMM）管理的虚拟机中运行。因此，Kata Containers 在两层 cgroup 上运行。第一层在虚拟机中放置工作负载，而第二层在主机上运行 VMM 和 关联线程。  </p>
<p>根据上级协调器，放置协调器的 cgroup 由协调器管理。 对于 Kubernetes，pod-cgroup 由 Kubelet 创建，而容器 cgroup 将由运行时处理。 Kubelet 将根据容器资源要求调整 pod-cgroup 的大小。  </p>
<p>Kata Containers 为运行 Sandbox（pod）引入了不可忽略的开销。 基于此，可能出现两种情况：</p>
<ol>
<li>调整 pod-cgroup 的大小时，上层协调器会考虑运行 Sandbox 的开销，或者</li>
<li>Kata Containers 没有完全约束 VMM 和关联的进程，而是将它们的子集放置在 pod-cgroup 之外。</li>
</ol>
<p>对于如何在主机上处理 cgroup，Kata Containers 提供了两个选项。 通过 Kata Containers 配置文件中的 SandboxCgroupOnly 标志可以选择这些选项。  </p>
<p>详细信息请查阅官方文档：<a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/host-cgroups.md">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/host-cgroups.md</a></p>
<ol start="7">
<li>Kata 2.0 指标设计</li>
</ol>
<hr>
<p>Kata 实现 CRI 的 API，并支持 ContainerStats 和 ListContainerStats 接口以公开容器指标。用户可以使用这些界面来获取有关容器的基本指标。  </p>
<p>但是与 runc 不同，Kata 是基于 VM 的运行时，并且具有不同的体系结构。  </p>
<p>Kata 1.x 有许多与可观察性相关的限制，可能会限制大规模运行 Kata Containers。  </p>
<p>在 Kata 2.0 中，以下组件将能够提供有关系统的更多详细信息。</p>
<ul>
<li>containerd shim v2 (effectively kata-runtime)</li>
<li>Hypervisor statistics</li>
<li>Agent process</li>
<li>Guest OS statistics</li>
</ul>
<blockquote>
<p>注意：在 Kata 1.x 中，面向用户的主要组件是运行时（kata-runtime）。从 1.5 开始，Kata 引入了 Kata containerd shim v2（containerd-shim-kata-v2），本质上是经过修改的运行时，由 containerd 加载，以简化和改进基于 VM 的容器的创建和管理方式。</p>
</blockquote>
<blockquote>
<p>对于 Kata 2.0，主要组件是 Kata containerd shim v2，尽管已弃用的 kata-runtime 二进制文件将保留一段时间。</p>
</blockquote>
<blockquote>
<p>除非另有明确说明（例如，明确地将其称为 kata-runtime 二进制文件），否则本文档中对 “Kata 运行时” 的任何提及均应指代 Kata containerd shim v2。</p>
</blockquote>
<h3 id="指标架构"><a href="#指标架构" class="headerlink" title="指标架构"></a>指标架构</h3><p>Kata 2.0 指标强烈依赖于 Prometheus，这是 CNCF 的毕业项目。  </p>
<p>Kata Containers 2.0 引入了一个名为 kata-monitor 的新 Kata 组件，该组件用于监视主机上的其他 Kata 组件。这是 Kata 运行时的监控接口，我们可以执行以下操作：</p>
<ul>
<li>Get metrics</li>
<li>Get events</li>
</ul>
<p>在本文档中，我们将仅涵盖指标。 直到现在，它仅支持指标功能。  </p>
<p>这是 Kata Containers 2.0 中的体系结构概述指标。  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/0c1a056159ce404314d9474e99b0101e.png">  </p>
<p>序列图如下所示：  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/21bc851b39f45779eb4e60d78ad4b05c.png">  </p>
<p>详细指标介绍请查阅官方文档：<a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-2-0-metrics.md">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/design/kata-2-0-metrics.md</a>  </p>
<p><strong>可以参考这个来收集函数运行内存。</strong>  </p>
<h2 id="附图："><a href="#附图：" class="headerlink" title="附图："></a>附图：</h2><p>create：  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/0f7ff1f36ba49de1cd2204d5e5a69d0d.png">  </p>
<p>start：  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img-blog.csdnimg.cn/img_convert/dcf03ee6045ea7b6b9e078862c30e94e.png">  </p>
<h1 id="How-To"><a href="#How-To" class="headerlink" title="How To"></a>How To</h1><h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>可使用 Fluentd 记录 Kata 的日志，包括 runtime、proxy、shim 甚至是 agent。<br>参考：<a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/how-to/how-to-import-kata-logs-with-fluentd.md">https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/how-to/how-to-import-kata-logs-with-fluentd.md</a>  </p>
<p>默认情况下，日志进入系统日志（system journal），但也可以配置为存储在文件中。  </p>
<p>日志默认格式为 logfmt 结构化日志记录，但可以使用命令行选项将其切换为 JSON。  </p>
<p>我们现在使用的是 shimev2，与之前有两个区别：</p>
<ol>
<li>Kata 日志通过 Containerd 进行定向，并将与 Containerd 日志一起捕获，例如在 Containerd 标准输出或系统日志（system journal）中。</li>
<li>同时，Kata shimv2 将其日志以 kata 的系统名称放置在系统日志（system journal）中。</li>
</ol>
<p>可以使用如下命令查看 Kata 的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u containerd.service -f</span><br></pre></td></tr></table></figure>


<p>如果需要开启全部组件的 debug，使用如下命令，<a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/Developer-Guide.md#enable-full-debug">参考</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># （可选）复制配置文件到 /etc/kata-containers/configuration.toml</span><br><span class="line"># mkdir -p /etc/kata-containers/</span><br><span class="line"># install -o root -g root -m 0640 /usr/share/defaults/kata-containers/configuration.toml /etc/kata-containers</span><br><span class="line"></span><br><span class="line">sed -i -e &#x27;s/^# *\(enable_debug\).*=.*$/\1 = true/g&#x27; /etc/kata-containers/configuration.toml</span><br><span class="line">sed -i -e &#x27;s/^kernel_params = &quot;\(.*\)&quot;/kernel_params = &quot;\1 agent.log=debug initcall_debug&quot;/g&#x27; /etc/kata-containers/configuration.toml</span><br></pre></td></tr></table></figure>

<h1 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title="Use Cases"></a>Use Cases</h1><p>Kata 与一些硬件集成使用的例子，可以提升性能。  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/Intel-GPU-passthrough-and-Kata.md">Using Intel GPU device with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/Nvidia-GPU-passthrough-and-Kata.md">Using Nvidia GPU device with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/using-Intel-QAT-and-kata.md">Using Intel QAT with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/using-SPDK-vhostuser-and-kata.md">Using SPDK vhostuser with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/using-SRIOV-and-kata.md">Using SRIOV with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/using-vpp-and-kata.md">Using VPP with Kata Containers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/2.0.0/docs/use-cases/zun_kata.md">OpenStack Zun DevStack working with Kata Containers</a></li>
</ul>
<h2 id="2-0-里程碑的预设目标"><a href="#2-0-里程碑的预设目标" class="headerlink" title="2.0 里程碑的预设目标"></a>2.0 里程碑的预设目标</h2><p>Kata 2.0 的主要目标包括：</p>
<ul>
<li><p>保持和已有的 Kubernetes 生态系统的兼容性；</p>
</li>
<li><p>允许将全部的应用内容，也就是说不仅是运行时的进程，也包括镜像 &#x2F; 根文件系统封装进沙箱中；</p>
</li>
<li><p>去掉 Agent 的不必要功能；</p>
</li>
<li><p>将宿主机的功能尽量留在用户空间，并让长生命周期进程可以使用非 root 权限运行；</p>
</li>
<li><p>支持 cloud-hypervisor 并为 Kata 的场景进行配置与定制。</p>
</li>
</ul>
<p>那么现在让我们来看看这会对架构和协议 &#x2F; 接口有什么潜在影响：</p>
<h2 id="对-CRI-接口的考虑"><a href="#对-CRI-接口的考虑" class="headerlink" title="对 CRI 接口的考虑"></a>对 CRI 接口的考虑</h2><p>就 Kubernetes 而言，所有运行时功能都通过容器运行时接口（CRI，定义位于 kubernetes&#x2F;cri-api）进行定义。仔细看一下，我们可以把 CRI 定义的功能分为两个部分——只关于节点本身的全局操作和有 Pod 上下文的操作：</p>
<ul>
<li><p>节点全局操作:</p>
</li>
<li><p><code>Version</code>, <code>Status</code></p>
</li>
<li><p><code>RunPodSandbox</code>, <code>ListPodSandbox</code>, <code>ListContainers</code>, <code>ListContainerStats</code></p>
</li>
<li><p><code>ListImages</code>, <code>ImageStatus</code>, <code>RemoveImage</code>, <code>ImageFsInfo</code></p>
</li>
<li><p>Pod 相关操作:</p>
</li>
<li><p><code>StopPodSandbox</code>, <code>RemovePodSandbox</code>, <code>PodSandboxStatus</code></p>
</li>
<li><p><code>CreateContainer</code>, <code>StartContainer</code>, <code>StopContainer</code>, <code>RemoveContainer</code>, <code>ContainerStatus</code>, <code>UpdateContainerResources</code>, <code>ReopenContainerLog</code>, <code>ContainerStats</code>, <code>UpdateRuntimeConfig</code></p>
</li>
<li><p><code>ExecSync</code>, <code>Exec</code>, <code>Attach</code>, <code>PortForward</code></p>
</li>
<li><p><code>PullImage</code></p>
</li>
</ul>
<p>注意 CRI 里面的 <code>PullImage</code> 是有 Pod 上下文的操作，这个操作从来都是在 PodSandbox 创建之后才进行的，并且从 Kubernetes 1.14 起，这个操作就带有一个 <code>PodSandboxConfig</code> 参数，其中的 <code>PodSandboxMetadata</code> 结构是包含 Pod 名称的。所以，作为一个高层定义，CRI 定义得非常谨慎，并没有假设镜像的文件系统究竟是维护在沙箱内还是宿主机全局的。</p>
<p>根据功能的划分，我们可以重新分配一下如何实现 CRI 的功能：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://mmbiz.qpic.cn/mmbiz_png/595z2h1fQpebFEYFYDTIhGRWW0tW30iaaxZRunuAiaiahGqgUmZwmmK6yD1noam2181fPEbsw9a6CbTGcvrsUcpCg/640?wx_fmt=png"></p>
<p>在 CRI Daemon，也就是目前 containerd 和 CRI-O 的位置，应该维护一个节点全局的 Pod 和容器的索引，并且它应该负责根据 RuntimeClass 来通过插件创建沙箱。此外的所有 Pod 内功能的操作应该交给负责 “Pod 相关功能” 的部分，也就是现在 shim-v2 的位置，不过我想它已经比一个垫片（shim）大太多了，可能叫 “沙箱伴侣” 更合适。</p>
<h3 id="对-CRI-Daemon-的影响"><a href="#对-CRI-Daemon-的影响" class="headerlink" title="对 CRI Daemon 的影响"></a>对 CRI Daemon 的影响</h3><p>要实现上述描述中的镜像进入沙箱的行为，CRI Daemon 需要有一些调整：</p>
<ul>
<li><p>短路掉节点全局功能中的镜像相关动作（<code>ListImages</code>, <code>ImageStatus</code>, <code>RemoveImage</code>, <code>ImageFsInfo</code>），因为我们把所有的镜像和 rootfs 管理操作都放到沙箱里了，所以也就没必要再做全局的镜像管理了。</p>
</li>
<li><p>对于拉取镜像，有两个选择：</p>
</li>
<li><p>如果我们尽量保持 shim-v2 接口的现状的话，我们可能需要在 daemon 里短路拉取镜像的操作，等到真的创建容器的时候再去事实地拉取镜像；</p>
</li>
<li><p>但是，上述方法的一个问题是，如果拉取镜像出错，那么只能表现为创建容器出错，这混淆了 API 本身的语义。而如果我们想让操作尽可能地忠于他们本身的语义的话，我们就应该把这个操作也添加到 shim-v2 接口里面。</p>
</li>
<li><p>对于 Create 和 Exec 操作，目前是 containerd 或者 CRI-O 创建标准输入输出 pipe 并交给 shim-v2 执行的，但我们如果希望进一步地隔离沙箱，就不应该使用宿主机上的管道，而应该把标准输入输出的实现的自由交给沙箱。</p>
</li>
</ul>
<p>当然我们肯定是要支持 containerd 和 CRI-O 的，并且要开箱即用，毕竟 containerd 和 CRI-O 已经跑在大多数人的机器上了。所以，上面这些改动应该是可插拔的，而且，我们在 Kata 2.0 中也应当对当前的 containerd 和 CRI-O 至少保留一个兼容模式。</p>
<h3 id="把容器放入沙箱中：效率与隔离性"><a href="#把容器放入沙箱中：效率与隔离性" class="headerlink" title="把容器放入沙箱中：效率与隔离性"></a>把容器放入沙箱中：效率与隔离性</h3><p>基于之前文章中的想法，我们做了一些把容器镜像拉取工作挪到沙箱里面的调研，大致如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://mmbiz.qpic.cn/mmbiz_png/595z2h1fQpebFEYFYDTIhGRWW0tW30iaaVsu7OdyEhEbj7GvfBTRNGNrOkZFYmBcXUpNU3HySicUFNdxnsNpoiatw/640?wx_fmt=png"></p>
<p>我们可以引入一个辅助容器专用来拉取镜像、制作容器 rootfs。把这个功能留给一个容器的目的在于，我们不希望为此来增加 agent 的复杂度，并且这样可以尽量少地影响 agent 本来的行为。</p>
<p>与把镜像放在宿主机上相比，把镜像放在沙箱中会消耗更多一些的空间，而且会影响容器启动的速度，因为每次启动 Pod 都必须拉一次镜像，但对于云用户来说，这样就不必让镜像被云服务商经手一次了，对于云用户和服务商来说，常常是可以接受的。</p>
<p>另一方面，OCI 在过去的一年里对下一代镜像规范进行了讨论，并推出了 OCI Image artifacts 扩展规范，合理利用 artifacts 可以让我们在 OCI 规范框架内进行一些工作来加速镜像的拉取，当然，这需要镜像用户授权基础设施来访问用户镜像内容来时下加速。这里是<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzUzOTk2OTQzOA==&mid=2247483897&idx=2&sn=4613d1dab5d1e6784e49d67342fcc8d4&chksm=fac11308cdb69a1eaf25ea90760577fa2261be8f8fbbba0f36d5cb331e4cb9943f467d05dcab&scene=21#wechat_redirect">我们在阿里巴巴和蚂蚁金服做的镜像加速</a>的一个示意：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://mmbiz.qpic.cn/mmbiz_png/595z2h1fQpebFEYFYDTIhGRWW0tW30iaaWPWics1vwep5lyxtb5MuaQOOlpicjJpVr3jRYGJqWc5x5D9QCQcqLUzQ/640?wx_fmt=png"></p>
<p>这里，利用 artifacts，我们可以把 “内容感知” 的元数据也一起放在 registry 里，在 Kata 这一端，我们可以在下载元数据之后就告知上层镜像拉取已经完成、可以启动容器了，当 virtiofsd 接到数据访问请求再延迟拉取镜像。这个方案中，所有的组件都位于用户空间，所以我们可以加入很多高级功能，比如更好的数据去重和 per-chunk 的数据校验，不需要全部拉取就可以进行数据完整性检查。（PS：这些逻辑对 Kata 和 runC 应该是通用的。）</p>
<h2 id="关于-Agent-的功能"><a href="#关于-Agent-的功能" class="headerlink" title="关于 Agent 的功能"></a>关于 Agent 的功能</h2><p>接下来是 sandbox 内部——“危险区”。我们对 agent 对考量包括：</p>
<ul>
<li><p>对于长时间运行对 daemon，应该仅仅包含必须要做的功能，能做的越少，我们也就越安全；</p>
</li>
<li><p>但是要保证和 OCI 镜像与 CRI 语义的兼容性；</p>
</li>
<li><p>当然，也要尽量低开销。</p>
</li>
</ul>
<p>在版本 1.10 的开发周期中，我们已经试验性地加入了一个 Rust 版本的 agent，它的体积要远小于之前的 Go 版本。而且，我们也实现了一个 Rust 版本的 ttRPC 并正在测试中（本文发出时已经开源并<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzUzOTk2OTQzOA==&mid=2247483911&idx=1&sn=28eb395482fd7e6835b3fd6f1e5af3a0&chksm=fac110f6cdb699e02d9d7ae6d2197183fb5d9415f0624c0e47fbb24dba3a26ef4a6184fcfb53&scene=21#wechat_redirect">贡献回到 ttRPC 的上游、containerd 社区</a>了），<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzUzOTk2OTQzOA==&mid=2247483897&idx=1&sn=4bfa20fcacbcd4f463ced3cc092095ab&chksm=fac11308cdb69a1edec111d0b7b608fa84afdcf27557c54ae1c802fc3b8d858feec36cd8be31&scene=21#wechat_redirect">把这些都集中在一起</a>，我们有望将 agent 的内存开销压向 0MB。</p>
<p>下面我们就来看看部分计划中的 Kata 2.0 的 agent 架构。</p>
<h3 id="Sandbox-操作"><a href="#Sandbox-操作" class="headerlink" title="Sandbox 操作"></a>Sandbox 操作</h3><p>在上海 PTG 上，agent 的功能也是讨论的焦点之一。部分开发者提起，agent protocol 中的 sandbox 操作对 agent 是否有意义，因为 agent 正在运行本身就意味着 sandbox 已经建立好了，所以，一个想法是要从协议中去掉 <code>CreateSandbox</code> 和 <code>DestroySandbox</code>两个操作。不过在 Kata 语境里， <code>CreateSandbox</code> 本身实际上是执行的 “InitSandbox” 操作，这个语义仍然是需要的。不过，我们可能确实可以去掉 pause container 来简化 sandbox 的容器组织。</p>
<h3 id="init-通信守护进程-和-OCI-启动器"><a href="#init-通信守护进程-和-OCI-启动器" class="headerlink" title="init, 通信守护进程, 和 OCI 启动器"></a>init, 通信守护进程, 和 OCI 启动器</h3><p>另一方面，我们也在考察 agent 的内在功能。在上海峰会的论坛讨论中，与会者都同意 agent 是被攻击风险最高的组件，显然应该让它的守护进程的权限越少越好。这里我们可以把 agent 的功能划分成这么几个部分：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://mmbiz.qpic.cn/mmbiz_png/595z2h1fQpebFEYFYDTIhGRWW0tW30iaa8pzib7PFzWS3jib5VibqzmnoyonzowHM7hqNd5Aoml4CrEH1JpNlcDjHw/640?wx_fmt=png"></p>
<ul>
<li><p>容器的 init 显然是需要的，无法删除。</p>
</li>
<li><p>在 bundle 内解析运行 OCI 容器的功能可以在容器创建之后退出。</p>
</li>
<li><p>监控、事件等关于可观测性、可调试性的功能肯定是需要的，但我们应该努力让它们更加安全高效。</p>
</li>
</ul>
<p>简而言之，agent 本身的发展方向应该是不仅更轻，而且更加模块化、并被更仔细地限制访问权限。</p>
<h2 id="Cloud-hypervisor-和-rust-vmm"><a href="#Cloud-hypervisor-和-rust-vmm" class="headerlink" title="Cloud-hypervisor 和 rust-vmm"></a>Cloud-hypervisor 和 rust-vmm</h2><p>在 1.10 开发周期里做的另一个工作是把 cloud-hypervisor 作为 Kata Containers 的一个新的 hypervisor，在 Kata 2.0 里，我们希望可以进一步推进这个方向。我在上一篇 blog 里提到：</p>
<blockquote>
<p>让主机的用户态工具、VMM、乃至应用的内核联合起来，彼此协同为沙箱中的应用提供服务。</p>
</blockquote>
<p>因为目前的 cloud-hypervisor 是一个中立、模块化和比较安全的 VMM，我们可以考虑构建一个 cloud-hypervisor 的 profile，添加我们需要的功能、减除不必要的功能，来作为我们的 “面向云原生的虚拟化” 的一个部分。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">哪吒藕霸</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/')">Kata Containers 2.0</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Kata Containers 2.0&amp;url=https://shippomx.github.io/2020/12/20/containers/Kata%20Containers%202.0%20%E4%BB%8B%E7%BB%8D/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://shippomx.github.io" target="_blank">远辰</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/container/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>container<span class="tagsPageCount">27</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/01/golang/20%E5%BC%A0%E5%8A%A8%E5%9B%BE%E4%B8%BA%E4%BD%A0%E6%BC%94%E7%A4%BAGo%E5%B9%B6%E5%8F%91/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">20 张动图演示 Go 并发</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/14/kidgets/tcpdump%20%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E6%9E%90/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">tcpdump 使用与数据分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/04/containers/Calico%20%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86%E6%8F%AD%E7%A7%98/" title="Calico网络通信简略原理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-04</div><div class="title">Calico网络通信简略原理</div></div></a></div><div><a href="/2021/12/21/containers/Docker%20%E7%9A%84%E7%BD%91%E7%BB%9C%20%E5%B0%86%E5%AE%B9%E5%99%A8%E4%B8%8E%E5%A4%96%E9%83%A8%E4%B8%96%E7%95%8C%E8%BF%9E%E6%8E%A5/" title="docker中的网络"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-12-21</div><div class="title">docker中的网络</div></div></a></div><div><a href="/2021/12/21/containers/Docker%20%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%AE%B9%E5%99%A8%E9%97%B4%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" title="docker中的网络模式"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-12-21</div><div class="title">docker中的网络模式</div></div></a></div><div><a href="/2023/10/07/containers/Docker%E5%AE%B9%E5%99%A8%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%8C%96/" title="Docker与虚拟化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-07</div><div class="title">Docker与虚拟化</div></div></a></div><div><a href="/2023/10/06/containers/Kubernetes%20CNI%20%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/" title="Kubernetes CNI 网络插件"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-06</div><div class="title">Kubernetes CNI 网络插件</div></div></a></div><div><a href="/2023/10/06/containers/Podman%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7/" title="Podman 的特性概述"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-06</div><div class="title">Podman 的特性概述</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kata-Containers-2-0"><span class="toc-number">1.</span> <span class="toc-text">Kata Containers 2.0</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Design"><span class="toc-number">2.</span> <span class="toc-text">Design</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A7%88"><span class="toc-number">2.0.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">2.0.2.</span> <span class="toc-text">虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%AE%B9%E5%99%A8%E6%A6%82%E5%BF%B5%E6%98%A0%E5%B0%84%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8A%80%E6%9C%AF"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">将容器概念映射到虚拟机技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kata-Container-Hypervisor-%E5%92%8C-VMM-%E6%94%AF%E6%8C%81"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">Kata Container Hypervisor 和 VMM 支持</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#gt-QEMU-x2F-KVM"><span class="toc-number">2.0.2.2.1.</span> <span class="toc-text">&gt; QEMU&#x2F;KVM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gt-Firecracker-x2F-KVM"><span class="toc-number">2.0.2.2.2.</span> <span class="toc-text">&gt; Firecracker&#x2F;KVM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gt-Cloud-Hypervisor-x2F-KVM"><span class="toc-number">2.0.2.2.3.</span> <span class="toc-text">&gt; Cloud Hypervisor&#x2F;KVM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#gt-%E6%80%BB%E7%BB%93"><span class="toc-number">2.0.2.2.4.</span> <span class="toc-text">&gt; 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA-Guest-assets"><span class="toc-number">2.0.3.</span> <span class="toc-text">虚拟机 Guest assets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Guest-kernel"><span class="toc-number">2.0.3.1.</span> <span class="toc-text">Guest kernel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Guest-Image"><span class="toc-number">2.0.3.2.</span> <span class="toc-text">Guest Image</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Root-filesystem-image"><span class="toc-number">2.0.3.2.1.</span> <span class="toc-text">Root filesystem image</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Initrd-image"><span class="toc-number">2.0.3.2.2.</span> <span class="toc-text">Initrd image</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent"><span class="toc-number">2.0.4.</span> <span class="toc-text">Agent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime"><span class="toc-number">2.0.5.</span> <span class="toc-text">Runtime</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C-Networking"><span class="toc-number">2.0.6.</span> <span class="toc-text">网络 Networking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8-Storage"><span class="toc-number">2.0.7.</span> <span class="toc-text">存储 Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes-support"><span class="toc-number">2.0.8.</span> <span class="toc-text">Kubernetes support</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Container-creation"><span class="toc-number">2.0.9.</span> <span class="toc-text">Container creation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Container-shutdown"><span class="toc-number">2.0.10.</span> <span class="toc-text">Container shutdown</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Workload-exit"><span class="toc-number">2.0.10.1.</span> <span class="toc-text">Workload exit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-manager-requested-shutdown"><span class="toc-number">2.0.10.2.</span> <span class="toc-text">Container manager requested shutdown</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">2.0.11.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DAX"><span class="toc-number">2.0.11.1.</span> <span class="toc-text">DAX</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.0.12.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82"><span class="toc-number">2.0.13.</span> <span class="toc-text">系统要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-VSOCK-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">2.0.14.</span> <span class="toc-text">使用 VSOCK 的优点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%AF%86%E5%BA%A6"><span class="toc-number">2.0.14.1.</span> <span class="toc-text">高密度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">2.0.14.2.</span> <span class="toc-text">可靠性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E6%9E%B6%E6%9E%84"><span class="toc-number">2.0.15.</span> <span class="toc-text">指标架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%9B%BE%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">附图：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-To"><span class="toc-number">3.</span> <span class="toc-text">How To</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">3.1.</span> <span class="toc-text">日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Use-Cases"><span class="toc-number">4.</span> <span class="toc-text">Use Cases</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-0-%E9%87%8C%E7%A8%8B%E7%A2%91%E7%9A%84%E9%A2%84%E8%AE%BE%E7%9B%AE%E6%A0%87"><span class="toc-number">4.1.</span> <span class="toc-text">2.0 里程碑的预设目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9-CRI-%E6%8E%A5%E5%8F%A3%E7%9A%84%E8%80%83%E8%99%91"><span class="toc-number">4.2.</span> <span class="toc-text">对 CRI 接口的考虑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9-CRI-Daemon-%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">4.2.1.</span> <span class="toc-text">对 CRI Daemon 的影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%8A%E5%AE%B9%E5%99%A8%E6%94%BE%E5%85%A5%E6%B2%99%E7%AE%B1%E4%B8%AD%EF%BC%9A%E6%95%88%E7%8E%87%E4%B8%8E%E9%9A%94%E7%A6%BB%E6%80%A7"><span class="toc-number">4.2.2.</span> <span class="toc-text">把容器放入沙箱中：效率与隔离性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-Agent-%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">4.3.</span> <span class="toc-text">关于 Agent 的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sandbox-%E6%93%8D%E4%BD%9C"><span class="toc-number">4.3.1.</span> <span class="toc-text">Sandbox 操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-%E9%80%9A%E4%BF%A1%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B-%E5%92%8C-OCI-%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">init, 通信守护进程, 和 OCI 启动器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloud-hypervisor-%E5%92%8C-rust-vmm"><span class="toc-number">4.4.</span> <span class="toc-text">Cloud-hypervisor 和 rust-vmm</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/08/cmake%20starter/" title="cmake starters">cmake starters</a><time datetime="2023-10-08T03:25:56.000Z" title="发表于 2023-10-08 11:25:56">2023-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/07/containers/Docker%E5%AE%B9%E5%99%A8%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%8C%96/" title="Docker与虚拟化">Docker与虚拟化</a><time datetime="2023-10-07T06:44:56.000Z" title="发表于 2023-10-07 14:44:56">2023-10-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/06/containers/Kubernetes%20CNI%20%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/" title="Kubernetes CNI 网络插件">Kubernetes CNI 网络插件</a><time datetime="2023-10-06T06:44:56.000Z" title="发表于 2023-10-06 14:44:56">2023-10-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/06/containers/Podman%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%80%A7/" title="Podman 的特性概述">Podman 的特性概述</a><time datetime="2023-10-06T06:44:56.000Z" title="发表于 2023-10-06 14:44:56">2023-10-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/06/containers/K8s%20scheduler%20%E8%AF%A6%E8%A7%A3/" title="Kubernetes scheduler详解">Kubernetes scheduler详解</a><time datetime="2023-10-06T06:44:56.000Z" title="发表于 2023-10-06 14:44:56">2023-10-06</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2023 By <a class="footer-bar-link" href="/" title="哪吒藕霸" target="_blank">哪吒藕霸</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/algorithm/" style="font-size: 0.88rem;">algorithm<sup>1</sup></a><a href="/tags/blockchain/" style="font-size: 0.88rem;">blockchain<sup>1</sup></a><a href="/tags/c/" style="font-size: 0.88rem;">c<sup>1</sup></a><a href="/tags/container/" style="font-size: 0.88rem;">container<sup>27</sup></a><a href="/tags/go/" style="font-size: 0.88rem;">go<sup>10</sup></a><a href="/tags/kidgets/" style="font-size: 0.88rem;">kidgets<sup>3</sup></a><a href="/tags/linux/" style="font-size: 0.88rem;">linux<sup>22</sup></a><a href="/tags/rust/" style="font-size: 0.88rem;">rust<sup>6</sup></a><a href="/tags/tools/" style="font-size: 0.88rem;">tools<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 哪吒藕霸 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "visitor@anheyu.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>